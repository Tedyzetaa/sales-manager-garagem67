analise:
Contexto do Projeto:
Desenvolvi um sistema de gest√£o de vendas com uma p√°gina de listagem de clientes. A interface mostra uma tabela com dados de clientes (Nome, Email, Telefone, √öltima Sincroniza√ß√£o) e um status "SINCRONIZADO" no rodap√©. H√° um bot√£o de sincroniza√ß√£o que precisa ser corrigido.

Problemas Identificados:

Integra√ß√£o de Sincroniza√ß√£o: A coluna "√öltima Sincroniza√ß√£o" est√° vazia para todos os clientes, mesmo mostrando status "SINCRONIZADO"

Posicionamento do Bot√£o: O bot√£o de sincronizar est√° isolado √† esquerda, desalinhado com outros controles da interface

Trechos Relevantes do C√≥digo Atual:

html
<!-- Estrutura da tabela -->
| Nome    | Email    | Telefone   | √öltima Sincroniza√ß√£o |
|---|---|---|---|
| Cliente Exemplo 1 | cliente1@email.com | (67) 99999-9999 | 0/31/2025 |

<!-- Status de sincroniza√ß√£o -->
---

**SINCRONIZADO**
Solicita√ß√µes de Corre√ß√£o:

Integra√ß√£o de Sincroniza√ß√£o:

Implemente uma fun√ß√£o para preencher a coluna "√öltima Sincroniza√ß√£o" com:

Timestamp real da √∫ltima sincroniza√ß√£o

Formato consistente (ex: DD/MM/YYYY HH:MM)

Conecte o status "SINCRONIZADO" ao estado real da API

Corre√ß√£o do Bot√£o de Sincronizar:

Reposicione o bot√£o para o cabe√ßalho da p√°gina, alinhado √† direita

Estilize consistentemente com outros bot√µes (ex: "Buscar clientes...")

Implemente funcionalidade completa incluindo:

Loading state durante a sincroniza√ß√£o

Feedback visual de sucesso/erro

Atualiza√ß√£o autom√°tica da lista ap√≥s sincroniza√ß√£o

Melhorias Adicionais:

Adicione tratamento de erros para falhas na sincroniza√ß√£o

Implemente confirma√ß√£o de sincroniza√ß√£o para m√∫ltiplos clientes

Atualize o timestamp individual para cada cliente sincronizado

Notas T√©cnicas:

Use √≠cone de sincroniza√ß√£o (‚Üª) padr√£o

Mantenha consist√™ncia com o design existente

Preveja estados de conex√£o offline/online

Considere performance para grandes volumes de clientes

Sa√≠da Esperada:

Coluna "√öltima Sincroniza√ß√£o" preenchida corretamente

Bot√£o de sincronizar integrado ao fluxo de trabalho principal

Feedback visual claro do status de sincroniza√ß√£o

Lista atualizando automaticamente ap√≥s opera√ß√µes
'''''''''''''
<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Sales Manager - Garagem 67</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="styles/main.css">
</head>
<body>
    <!-- Tela de Login -->
    <div id="login-page" class="active">
        <div class="login-container">
            <div class="login-card">
                <div class="login-header">
                    <i class="fas fa-warehouse"></i>
                    <h2>Sales Manager</h2>
                    <small>Garagem 67 - Sistema de Vendas</small>
                </div>
                
                <form id="login-form">
                    <div class="form-group">
                        <label for="username">Usu√°rio</label>
                        <input type="text" id="username" class="form-control" placeholder="Digite seu usu√°rio" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="password">Senha</label>
                        <input type="password" id="password" class="form-control" placeholder="Digite sua senha" required>
                    </div>
                    
                    <button type="button" class="btn btn-primary btn-block" id="login-btn">
                        <i class="fas fa-sign-in-alt"></i> Entrar no Sistema
                    </button>
                
                    <div class="login-footer">
                        <div class="demo-credentials">
                            <strong>Credenciais de Demonstra√ß√£o:</strong><br>
                            Usu√°rio: <strong>admin</strong> | Senha: <strong>admin123</strong>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Aplica√ß√£o Principal (inicialmente oculta) -->
    <div id="app" style="display: none;">
        <!-- Header -->
        <header class="header">
            <div class="header-left">
                <div class="logo">
                    <i class="fas fa-chart-line"></i>
                    <span>Sales Manager <small>v2.0.0</small></span>
                </div>
            </div>
            
            <div class="header-center">
                <div class="status-indicator online" id="connection-status">
                    <i class="fas fa-circle"></i>
                    <span id="status-text">Conectado</span>
                </div>
            </div>
            
            <div class="header-right">
                <div class="user-info">
                    <span id="current-user">Usu√°rio</span>
                    <button type="button" class="btn-logout" id="logout-btn">
                        <i class="fas fa-sign-out-alt"></i> Sair
                    </button>
                </div>
            </div>
        </header>

        <!-- Layout Principal -->
        <div class="main-layout">
            <!-- Sidebar -->
            <nav class="sidebar">
                <div class="sidebar-menu">
                    <a href="#" class="menu-item active" data-page="dashboard">
                        <i class="fas fa-tachometer-alt"></i>
                        <span>Dashboard</span>
                    </a>
                    
                    <a href="#" class="menu-item" data-page="sales">
                        <i class="fas fa-shopping-cart"></i>
                        <span>Vendas</span>
                    </a>

                    <li>
                        <a href="/sync.html">
                            <i class="fas fa-sync"></i> Sincroniza√ß√£o
                        </a>
                    </li>
                    
                    <a href="#" class="menu-item" data-page="products">
                        <i class="fas fa-boxes"></i>
                        <span>Produtos</span>
                    </a>
                    
                    <a href="#" class="menu-item" data-page="inventory">
                        <i class="fas fa-warehouse"></i>
                        <span>Estoque</span>
                    </a>
                    
                    <a href="#" class="menu-item" data-page="customers">
                        <i class="fas fa-users"></i>
                        <span>Clientes</span>
                    </a>
                    
                    <a href="#" class="menu-item" data-page="reports">
                        <i class="fas fa-chart-bar"></i>
                        <span>Relat√≥rios</span>
                    </a>
                </div>
                
                <div class="sidebar-footer">
                    <div class="system-info">
                        <span>Garagem 67</span>
                        <span id="sync-status" class="sync-status synced">Sincronizado</span>
                    </div>
                </div>
            </nav>

            <!-- Conte√∫do Principal -->
            <main class="main-content">
                <!-- Dashboard Page -->
                <div id="dashboard-page" class="page active">
                    <div class="page-header">
                        <h1><i class="fas fa-tachometer-alt"></i> Dashboard</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-outline" id="refresh-dashboard">
                                <i class="fas fa-sync-alt"></i> Atualizar
                            </button>
                            <button type="button" class="btn btn-primary" id="force-sync">
                                <i class="fas fa-sync"></i> Sincronizar
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon sales">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-sales">0</h3>
                                <p>Vendas Hoje</p>
                            </div>
                            <div class="stat-trend positive" id="sales-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon revenue">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-revenue">R$ 0,00</h3>
                                <p>Receita Hoje</p>
                            </div>
                            <div class="stat-trend positive" id="revenue-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-icon products">
                                <i class="fas fa-exclamation-triangle"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="low-stock">0</h3>
                                <p>Estoque Baixo</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon customers">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="total-customers">0</h3>
                                <p>Clientes Ativos</p>
                            </div>
                            <div class="stat-trend positive" id="customers-trend">
                                <i class="fas fa-arrow-up"></i>
                                <span>0%</span>
                            </div>
                        </div>
                    </div>

                    <!-- M√©tricas em Tempo Real -->
                    <div class="real-time-metrics">
                        <div class="metric-card">
                            <div class="metric-value" id="average-ticket">R$ 0,00</div>
                            <div class="metric-label">Ticket M√©dio</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="conversion-rate">0%</div>
                            <div class="metric-label">Taxa de Convers√£o</div>
                        </div>
                        <div class="metric-card">
                            <div class="metric-value" id="top-product">N/A</div>
                            <div class="metric-label">Produto Mais Vendido</div>
                        </div>
                    </div>
                    
                    <div class="dashboard-content">
                        <div class="chart-section">
                            <div class="section-header">
                                <h3>Vendas dos √öltimos 7 Dias</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="sales-chart"></canvas>
                            </div>
                        </div>
                        
                        <div class="recent-section">
                            <div class="section-header">
                                <h3>Vendas Recentes</h3>
                            </div>
                            <div class="recent-list" id="recent-sales">
                                <div class="empty-state">
                                    <i class="fas fa-shopping-cart"></i>
                                    <p>Nenhuma venda recente</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                                <!-- Sales Page -->
                <div id="sales-page" class="page">
                    <div class="page-header">
                        <h1><i class="fas fa-shopping-cart"></i> Vendas</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-primary" id="new-sale-btn">
                                <i class="fas fa-plus"></i> Nova Venda
                            </button>
                        </div>
                    </div>
                    
                    <!-- Filtros de Vendas -->
                    <div class="filters-section">
                        <div class="filter-group">
                            <div class="filter-item">
                                <label for="sales-date-filter">Data:</label>
                                <input type="date" id="sales-date-filter" class="form-control">
                            </div>
                            <div class="filter-item">
                                <label for="sales-status-filter">Status:</label>
                                <select id="sales-status-filter" class="form-control">
                                    <option value="all">Todas</option>
                                    <option value="completed">Conclu√≠das</option>
                                    <option value="pending">Pendentes</option>
                                    <option value="cancelled">Canceladas</option>
                                </select>
                            </div>
                            <div class="filter-item">
                                <label for="sales-payment-filter">Pagamento:</label>
                                <select id="sales-payment-filter" class="form-control">
                                    <option value="all">Todos</option>
                                    <option value="dinheiro">Dinheiro</option>
                                    <option value="cartao">Cart√£o</option>
                                    <option value="pix">PIX</option>
                                </select>
                            </div>
                            <button type="button" class="btn btn-outline" id="apply-sales-filters">
                                <i class="fas fa-filter"></i> Filtrar
                            </button>
                        </div>
                    </div>
                    
                    <!-- Resumo de Vendas -->
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-icon sales">
                                <i class="fas fa-shopping-cart"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="sales-today-count">0</h3>
                                <p>Vendas Hoje</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon revenue">
                                <i class="fas fa-dollar-sign"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="sales-today-revenue">R$ 0,00</h3>
                                <p>Receita Hoje</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-icon customers">
                                <i class="fas fa-users"></i>
                            </div>
                            <div class="stat-info">
                                <h3 id="sales-avg-ticket">R$ 0,00</h3>
                                <p>Ticket M√©dio</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="page-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Hist√≥rico de Vendas</h3>
                                <div class="card-actions">
                                    <input type="text" id="sales-search" placeholder="Buscar vendas..." class="form-control">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>C√≥digo</th>
                                                <th>Cliente</th>
                                                <th>Data</th>
                                                <th>Itens</th>
                                                <th>Total</th>
                                                <th>Pagamento</th>
                                                <th>Status</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="sales-table-body">
                                            <tr>
                                                <td colspan="8" class="empty-state">
                                                    <i class="fas fa-shopping-cart"></i>
                                                    <p>Nenhuma venda encontrada</p>
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="app.showSaleModal()">
                                                        <i class="fas fa-plus"></i> Realizar Primeira Venda
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Products Page -->
                <div id="products-page" class="page">
                    <div class="page-header">
                        <h1><i class="fas fa-boxes"></i> Produtos</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-primary" id="new-product-btn">
                                <i class="fas fa-plus"></i> Novo Produto
                            </button>
                        </div>
                    </div>
                    
                    <div class="page-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Lista de Produtos</h3>
                                <div class="card-actions">
                                    <input type="text" id="products-search" placeholder="Buscar produtos..." class="form-control">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="data-table">
                                       <thead>
                                        <tr>
                                            <th>C√≥digo</th>
                                            <th>Cliente</th>
                                            <th>Data</th>
                                            <th>Itens</th>
                                            <th>Total</th>
                                            <th>Pagamento</th>
                                            <th>Status</th>
                                            <th>A√ß√µes</th>
                                        </tr>
                                    </thead>
                                        <tbody id="products-table-body">
                                            <tr>
                                                <td colspan="6" class="empty-state">
                                                    <i class="fas fa-boxes"></i>
                                                    <p>Nenhum produto cadastrado</p>
                                                    <button type="button" class="btn btn-primary btn-sm" onclick="app.showProductModal()">
                                                        <i class="fas fa-plus"></i> Cadastrar Primeiro Produto
                                                    </button>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Inventory Page -->
                <div id="inventory-page" class="page">
                    <div class="page-header">
                        <h1><i class="fas fa-warehouse"></i> Estoque</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-primary" id="new-movement-btn">
                                <i class="fas fa-plus"></i> Nova Movimenta√ß√£o
                            </button>
                        </div>
                    </div>
                    
                    <div class="stats-grid">
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="total-products">0</h3>
                                <p>Total de Produtos</p>
                            </div>
                        </div>
                        
                        <div class="stat-card">
                            <div class="stat-info">
                                <h3 id="total-stock-value">R$ 0,00</h3>
                                <p>Valor em Estoque</p>
                            </div>
                        </div>
                        
                        <div class="stat-card warning">
                            <div class="stat-info">
                                <h3 id="low-stock-count">0</h3>
                                <p>Estoque Baixo</p>
                            </div>
                        </div>
                        
                        <div class="stat-card danger">
                            <div class="stat-info">
                                <h3 id="out-of-stock-count">0</h3>
                                <p>Sem Estoque</p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="page-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Relat√≥rio de Estoque</h3>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Produto</th>
                                                <th>Categoria</th>
                                                <th>Estoque Atual</th>
                                                <th>Estoque M√≠nimo</th>
                                                <th>Status</th>
                                                <th>Valor Estoque</th>
                                                <th>A√ß√µes</th>
                                            </tr>
                                        </thead>
                                        <tbody id="inventory-table-body">
                                            <tr>
                                                <td colspan="7" class="empty-state">
                                                    <i class="fas fa-warehouse"></i>
                                                    <p>Nenhum produto em estoque</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Customers Page -->
                <div id="customers-page" class="page">
                    <div class="page-header">
                        <h1><i class="fas fa-users"></i> Clientes</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-primary" id="sync-customers-page-btn">
                                <i class="fas fa-sync"></i> Sincronizar Clientes
                            </button>
                        </div>
                    </div>
                    
                    <div class="page-content">
                        <div class="card">
                            <div class="card-header">
                                <h3>Lista de Clientes</h3>
                                <div class="card-actions">
                                    <input type="text" id="customers-search" placeholder="Buscar clientes..." class="form-control">
                                </div>
                            </div>
                            <div class="card-body">
                                <div class="table-container">
                                    <table class="data-table">
                                        <thead>
                                            <tr>
                                                <th>Nome</th>
                                                <th>Email</th>
                                                <th>Telefone</th>
                                                <th>√öltima Sincroniza√ß√£o</th>
                                            </tr>
                                        </thead>
                                        <tbody id="customers-table-body">
                                            <tr>
                                                <td colspan="4" class="empty-state">
                                                    <i class="fas fa-users"></i>
                                                    <p>Nenhum cliente encontrado</p>
                                                </td>
                                            </tr>
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Reports Page -->
                <div id="reports-page" class="page">
                    <div class="page-header">
                        <h1><i class="fas fa-chart-bar"></i> Relat√≥rios</h1>
                        <div class="page-actions">
                            <button type="button" class="btn btn-primary" id="generate-report">
                                <i class="fas fa-download"></i> Gerar Relat√≥rio
                            </button>
                        </div>
                    </div>
                    
                    <div class="page-content">
                        <div class="advanced-filters">
                            <div class="filter-group">
                                <div class="filter-item">
                                    <label for="report-period">Per√≠odo:</label>
                                    <select id="report-period" class="form-control">
                                        <option value="today">Hoje</option>
                                        <option value="yesterday">Ontem</option>
                                        <option value="week">√öltima Semana</option>
                                        <option value="month">√öltimo M√™s</option>
                                        <option value="quarter">√öltimo Trimestre</option>
                                        <option value="custom">Personalizado</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item">
                                    <label for="report-type">Tipo de Relat√≥rio:</label>
                                    <select id="report-type" class="form-control">
                                        <option value="sales">Vendas</option>
                                        <option value="inventory">Estoque</option>
                                        <option value="customers">Clientes</option>
                                    </select>
                                </div>

                                <div class="filter-item">
                                    <label for="report-format">Formato:</label>
                                    <select id="report-format" class="form-control">
                                        <option value="csv">CSV</option>
                                        <option value="json">JSON</option>
                                        <option value="pdf">PDF</option>
                                    </select>
                                </div>
                                
                                <div class="filter-item" id="custom-dates" style="display: none;">
                                    <label for="start-date">Data Inicial:</label>
                                    <input type="date" id="start-date" class="form-control">
                                    
                                    <label for="end-date">Data Final:</label>
                                    <input type="date" id="end-date" class="form-control">
                                </div>
                                
                                <button type="button" class="btn btn-outline" id="apply-filters">
                                    <i class="fas fa-filter"></i> Aplicar Filtros
                                </button>
                            </div>

                            <div class="export-options">
                                <button type="button" class="export-btn csv" id="export-report-csv">
                                    <i class="fas fa-file-csv"></i> Exportar CSV
                                </button>
                                <button type="button" class="export-btn json" id="export-report-json">
                                    <i class="fas fa-file-code"></i> Exportar JSON
                                </button>
                                <button type="button" class="export-btn pdf" id="export-report-pdf">
                                    <i class="fas fa-file-pdf"></i> Exportar PDF
                                </button>
                            </div>
                        </div>
                        
                        <div class="stats-grid">
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="report-total-sales">0</h3>
                                    <p>Total de Vendas</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="report-total-revenue">R$ 0,00</h3>
                                    <p>Receita Total</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="report-average-ticket">R$ 0,00</h3>
                                    <p>Ticket M√©dio</p>
                                </div>
                            </div>
                            
                            <div class="stat-card">
                                <div class="stat-info">
                                    <h3 id="report-products-sold">0</h3>
                                    <p>Produtos Vendidos</p>
                                </div>
                            </div>
                        </div>
                        
                        <div class="chart-section">
                            <div class="section-header">
                                <h3>Gr√°fico de Relat√≥rio</h3>
                            </div>
                            <div class="chart-container">
                                <canvas id="report-chart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </main>
        </div>
    </div>

    <!-- Loading Overlay -->
    <div id="loading-overlay" class="loading-overlay">
        <div class="spinner"></div>
        <p id="loading-message">Carregando...</p>
    </div>
    <!-- TEMPOR√ÅRIO: Bot√£o de debug -->
    <div style="position: fixed; bottom: 20px; right: 20px; z-index: 1000;">
        <button class="btn btn-warning btn-sm" onclick="app.debugReloadProducts()" title="Debug">
            <i class="fas fa-bug"></i> Debug Produtos
        </button>
    </div>

    <!-- Firebase SDK (PRIMEIRO) -->
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-firestore-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.0.0/firebase-storage-compat.js"></script>

    <!-- Nossos Scripts (NA ORDEM CORRETA) -->
    <script src="js/firebase-config.js"></script>
    <script src="js/api.js"></script>
    <script src="js/app.js"></script>

    <!-- Scripts Adicionais -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script src="js/localStorage.js"></script>
    <script src="js/cacheManager.js"></script>
    <script src="js/dashboard.js"></script>
    <script src="js/shortcuts.js"></script>
    <script src="js/exportManager.js"></script>
    <script src="js/syncManager.js"></script>
</body>
</html>
''''''''''''
const FirebaseService = require('./firebaseService');

class SyncService {
    constructor() {
        this.isSyncing = false;
        this.syncInterval = null;
    }

    startAutoSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
        }

        // Sincronizar a cada 5 minutos
        this.syncInterval = setInterval(() => {
            this.syncAll();
        }, 5 * 60 * 1000);

        console.log('üîÑ Sincroniza√ß√£o autom√°tica iniciada (5 minutos)');
        
        // Sincronizar imediatamente ao iniciar
        this.syncAll();
    }

    stopAutoSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
        console.log('üîÑ Sincroniza√ß√£o autom√°tica parada');
    }

    async syncAll() {
        if (this.isSyncing) {
            console.log('‚è≥ Sincroniza√ß√£o j√° em andamento...');
            return;
        }

        this.isSyncing = true;
        
        try {
            console.log('üîÑ Iniciando sincroniza√ß√£o completa...');
            
            // Sincronizar clientes do Firebase
            const customerResult = await FirebaseService.syncCustomers();
            
            console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${customerResult.synced || 0} clientes`);
            
            return {
                success: true,
                customers: customerResult,
                timestamp: new Date().toISOString()
            };
            
        } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o:', error);
            return {
                success: false,
                error: error.message,
                timestamp: new Date().toISOString()
            };
        } finally {
            this.isSyncing = false;
        }
    }

    async forceSync() {
        console.log('üîÑ For√ßando sincroniza√ß√£o manual...');
        return await this.syncAll();
    }

    getSyncStatus() {
        return {
            isSyncing: this.isSyncing,
            lastSync: new Date().toISOString(),
            autoSyncEnabled: this.syncInterval !== null
        };
    }

    // No services/syncService.js - ADICIONAR estas fun√ß√µes

// üîÑ Sincroniza√ß√£o REAL com Garagem67
async syncCustomersReal() {
    if (this.syncInProgress) {
        throw new Error('Sincroniza√ß√£o j√° em andamento');
    }

    this.syncInProgress = true;

    try {
        console.log('üîÑ Iniciando sincroniza√ß√£o REAL com Garagem67...');
        
        // ‚úÖ CORRE√á√ÉO: Tentar conectar com Firebase real
        let firebaseCustomers = [];
        
        try {
            await this.initializeFirebaseAdmin();
            const db = admin.app('Garagem67Sync').firestore();
            const snapshot = await db.collection('customers').get();
            
            snapshot.forEach(doc => {
                const customerData = doc.data();
                firebaseCustomers.push({
                    firebase_id: doc.id,
                    name: customerData.name || customerData.nome || 'Cliente sem nome',
                    email: customerData.email || customerData.email,
                    phone: customerData.phone || customerData.telefone || customerData.celular,
                    cpf: customerData.cpf || customerData.document,
                    address: customerData.address || customerData.endereco,
                    city: customerData.city || customerData.cidade || 'Ivinhema',
                    state: customerData.state || customerData.estado || 'MS',
                    cep: customerData.cep || customerData.postalCode,
                    complemento: customerData.complemento || customerData.complement,
                    is_active: true
                });
            });
            
            console.log(`üì• ${firebaseCustomers.length} clientes encontrados no Firebase`);
            
        } catch (firebaseError) {
            console.warn('‚ö†Ô∏è Firebase n√£o dispon√≠vel, usando dados de exemplo:', firebaseError.message);
            // Usar dados de exemplo se Firebase falhar
            firebaseCustomers = this.getMockCustomers();
        }

        let created = 0;
        let updated = 0;
        let errors = 0;

        // Processar cada cliente
        for (const customerData of firebaseCustomers) {
            try {
                const existingStmt = db.prepare('SELECT id FROM customers WHERE firebase_id = ? OR email = ?');
                const existing = existingStmt.get(customerData.firebase_id, customerData.email);

                const now = new Date().toISOString();

                if (existing) {
                    // Atualizar cliente existente
                    const updateStmt = db.prepare(`
                        UPDATE customers SET 
                        name = ?, email = ?, phone = ?, cpf = ?, address = ?, 
                        city = ?, state = ?, cep = ?, complemento = ?, last_sync = ?
                        WHERE id = ?
                    `);
                    
                    const result = updateStmt.run(
                        customerData.name,
                        customerData.email,
                        customerData.phone,
                        customerData.cpf,
                        customerData.address,
                        customerData.city,
                        customerData.state,
                        customerData.cep,
                        customerData.complemento,
                        now,
                        existing.id
                    );
                    
                    if (result.changes > 0) updated++;
                } else {
                    // Inserir novo cliente
                    const insertStmt = db.prepare(`
                        INSERT INTO customers 
                        (firebase_id, name, email, phone, cpf, address, city, state, cep, complemento, last_sync, created_at) 
                        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                    `);
                    
                    const result = insertStmt.run(
                        customerData.firebase_id,
                        customerData.name,
                        customerData.email,
                        customerData.phone,
                        customerData.cpf,
                        customerData.address,
                        customerData.city,
                        customerData.state,
                        customerData.cep,
                        customerData.complemento,
                        now,
                        now
                    );
                    
                    if (result.changes > 0) created++;
                }
            } catch (error) {
                console.error(`‚ùå Erro ao processar cliente ${customerData.firebase_id}:`, error);
                errors++;
            }
        }

        // Salvar estat√≠sticas
        await this.updateSyncStatistics(`real_sync_${Date.now()}`, {
            created,
            updated,
            errors,
            skipped: 0,
            synced: created + updated
        }, 'garagem67_real_sync');

        const resultMessage = `‚úÖ Sincroniza√ß√£o REAL: ${created} novos, ${updated} atualizados, ${errors} erros`;
        console.log(resultMessage);
        
        return {
            success: true,
            message: resultMessage,
            statistics: {
                created,
                updated,
                errors,
                skipped: 0,
                synced: created + updated,
                total_found: firebaseCustomers.length
            },
            timestamp: new Date().toISOString(),
            source: 'garagem67_firebase'
        };

    } catch (error) {
        console.error('‚ùå Erro na sincroniza√ß√£o REAL:', error);
        throw error;
    } finally {
        this.syncInProgress = false;
    }
}

// üìã Dados de exemplo para desenvolvimento
getMockCustomers() {
    return [
        {
            firebase_id: 'garagem67_cust_001',
            name: 'Jo√£o Silva - Garagem67',
            email: 'joao@garagem67.com',
            phone: '(67) 99999-9999',
            cpf: '123.456.789-00',
            address: 'Rua Principal, 123',
            city: 'Ivinhema',
            state: 'MS',
            cep: '79760-000',
            complemento: 'Centro',
            is_active: true
        },
        {
            firebase_id: 'garagem67_cust_002',
            name: 'Maria Santos - Garagem67',
            email: 'maria@garagem67.com',
            phone: '(67) 98888-8888',
            cpf: '987.654.321-00',
            address: 'Av. Central, 456',
            city: 'Ivinhema', 
            state: 'MS',
            cep: '79760-000',
            complemento: 'Pr√≥ximo ao mercado',
            is_active: true
        },
        {
            firebase_id: 'garagem67_cust_003',
            name: 'Pedro Oliveira - Garagem67',
            email: 'pedro@garagem67.com',
            phone: '(67) 97777-7777',
            cpf: '456.789.123-00',
            address: 'Rua das Flores, 789',
            city: 'Ivinhema',
            state: 'MS',
            cep: '79760-000',
            complemento: '',
            is_active: true
        }
    ];
}

}

module.exports = SyncService;
'''''''''''''
class SyncManager {
    constructor() {
        this.isSyncing = false;
        this.lastSync = null;
        this.syncInterval = null;
        this.autoSyncEnabled = true;
    }

    startBackgroundSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
        }

        this.syncInterval = setInterval(() => {
            if (this.autoSyncEnabled && !this.isSyncing) {
                this.autoSync();
            }
        }, 300000);

        console.log('üîÑ Sincroniza√ß√£o em segundo plano ativada');
    }

    stopBackgroundSync() {
        if (this.syncInterval) {
            clearInterval(this.syncInterval);
            this.syncInterval = null;
        }
        console.log('üîÑ Sincroniza√ß√£o em segundo plano desativada');
    }

    async autoSync() {
        if (this.isSyncing) {
            console.log('üîÑ Sincroniza√ß√£o j√° em andamento...');
            return;
        }

        this.isSyncing = true;
        
        try {
            console.log('üîÑ Iniciando sincroniza√ß√£o autom√°tica...');
            
            await api.syncCustomers();
            
            this.lastSync = new Date();
            this.updateSyncStatus();
            
            console.log('‚úÖ Sincroniza√ß√£o autom√°tica conclu√≠da');
            
        } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
        } finally {
            this.isSyncing = false;
        }
    }

    async forceSync() {
        this.isSyncing = true;
        app.showLoading(true, 'Sincronizando dados...');
        
        try {
            const response = await api.forceSync();
            
            if (response.success) {
                this.lastSync = new Date();
                this.updateSyncStatus();
                
                app.showNotification('Sincroniza√ß√£o for√ßada conclu√≠da com sucesso', 'success');
                app.refreshDashboard();
                
            } else {
                throw new Error(response.error || 'Erro na sincroniza√ß√£o');
            }
            
        } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o for√ßada:', error);
            app.showNotification('Erro na sincroniza√ß√£o: ' + error.message, 'error');
        } finally {
            this.isSyncing = false;
            app.showLoading(false);
        }
    }

    updateSyncStatus() {
        const statusElement = document.getElementById('sync-status');
        
        if (statusElement) {
            statusElement.textContent = this.isSyncing ? 'Sincronizando...' : 'Sincronizado';
            statusElement.className = this.isSyncing ? 'sync-status syncing' : 'sync-status synced';
        }
    }

    getSyncStatus() {
        return {
            isSyncing: this.isSyncing,
            lastSync: this.lastSync,
            autoSyncEnabled: this.autoSyncEnabled
        };
    }

    enableAutoSync() {
        this.autoSyncEnabled = true;
        this.startBackgroundSync();
    }

    disableAutoSync() {
        this.autoSyncEnabled = false;
        this.stopBackgroundSync();
    }
}

window.syncManager = new SyncManager();
''''''''''''''
console.log('üöÄ Enhanced app.js carregado - VENDAS REIMPLEMENTADAS');

class EnhancedApp {
    constructor() {
        this.currentUser = null;
        this.currentPage = 'dashboard';
        this.products = [];
        this.customers = [];
        this.sales = [];
        this.isInitialized = false;
        this.currentSale = {
            items: [],
            customer_id: null,
            payment_method: '',
            observations: ''
        };
        
        console.log('üîÑ EnhancedApp Constructor Iniciado');
        this.safeInit();
    }

    async safeInit() {
        try {
            if (document.readyState === 'loading') {
                document.addEventListener('DOMContentLoaded', () => this.init());
            } else {
                setTimeout(() => this.init(), 100);
            }
        } catch (error) {
            console.error('üí• Erro cr√≠tico no safeInit:', error);
        }
    }

    async init() {
        if (this.isInitialized) {
            console.log('‚ö†Ô∏è App j√° inicializado');
            return;
        }

        try {
            console.log('üöÄ Inicializando Enhanced Sales Manager App...');
            
            this.forceShowLogin();
            this.initializeEventListeners();
            await this.checkAuthentication();
            
            // ‚úÖ CORRE√á√ÉO: Debug dos bot√µes
            setTimeout(() => {
                this.debugSyncButtons();
            }, 2000);
            
            this.isInitialized = true;
            console.log('‚úÖ Enhanced App Inicializado e Corrigido');

        } catch (error) {
            console.error('üí• Erro cr√≠tico na inicializa√ß√£o:', error);
        }
    }

    initializeEventListeners() {
        console.log('üéØ Inicializando event listeners CORRIGIDOS...');
        
        // ‚úÖ CORRE√á√ÉO: Usar setTimeout para garantir que o DOM esteja pronto
        setTimeout(() => {
            try {
                // ‚úÖ CORRE√á√ÉO: Bot√£o de sincroniza√ß√£o do DASHBOARD
                const forceSyncBtn = document.getElementById('force-sync');
                if (forceSyncBtn) {
                    console.log('‚úÖ Bot√£o force-sync encontrado, adicionando listener...');
                    forceSyncBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîÑ Bot√£o sync clicado no dashboard!');
                        this.syncCustomers();
                    });
                    
                    // ‚úÖ CORRE√á√ÉO EXTRA: Adicionar onclick tamb√©m como backup
                    forceSyncBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üéØ Clique direto no bot√£o sync!');
                        this.syncCustomers();
                    };
                } else {
                    console.log('‚ùå Bot√£o force-sync N√ÉO encontrado!');
                }

                // ‚úÖ CORRE√á√ÉO: Bot√£o de sincroniza√ß√£o da P√ÅGINA DE CLIENTES
                const syncCustomersBtn = document.getElementById('sync-customers-page-btn');
                if (syncCustomersBtn) {
                    console.log('‚úÖ Bot√£o sync-customers-page-btn encontrado, adicionando listener...');
                    syncCustomersBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üîÑ Bot√£o sync clicado na p√°gina de clientes!');
                        this.syncCustomers();
                    });
                    
                    // ‚úÖ CORRE√á√ÉO EXTRA: Adicionar onclick tamb√©m como backup
                    syncCustomersBtn.onclick = (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        console.log('üéØ Clique direto no bot√£o sync clientes!');
                        this.syncCustomers();
                    };
                } else {
                    console.log('‚ùå Bot√£o sync-customers-page-btn N√ÉO encontrado!');
                }

                // Login
                const loginBtn = document.getElementById('login-btn');
                if (loginBtn) {
                    loginBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                const loginForm = document.getElementById('login-form');
                if (loginForm) {
                    loginForm.addEventListener('submit', (e) => {
                        e.preventDefault();
                        this.handleLogin();
                    });
                }

                // Logout
                const logoutBtn = document.getElementById('logout-btn');
                if (logoutBtn) {
                    logoutBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.handleLogout();
                    });
                }

                // Navega√ß√£o
                document.querySelectorAll('.menu-item').forEach(item => {
                    item.addEventListener('click', (e) => {
                        e.preventDefault();
                        const page = item.getAttribute('data-page');
                        this.showPage(page);
                    });
                });

                // Produtos
                const newProductBtn = document.getElementById('new-product-btn');
                if (newProductBtn) {
                    newProductBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showProductModal();
                    });
                }

                // ‚úÖ VENDAS: Bot√£o nova venda
                const newSaleBtn = document.getElementById('new-sale-btn');
                if (newSaleBtn) {
                    newSaleBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.showSaleModal();
                    });
                }

                // ‚úÖ VENDAS: Filtros
                const applySalesFilters = document.getElementById('apply-sales-filters');
                if (applySalesFilters) {
                    applySalesFilters.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.loadSales();
                    });
                }

                // Refresh Dashboard
                const refreshBtn = document.getElementById('refresh-dashboard');
                if (refreshBtn) {
                    refreshBtn.addEventListener('click', (e) => {
                        e.preventDefault();
                        this.refreshDashboard();
                    });
                }

                console.log('‚úÖ Todos os event listeners configurados CORRETAMENTE');

            } catch (error) {
                console.error('‚ùå Erro cr√≠tico ao configurar event listeners:', error);
            }
        }, 1000);
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o de debug
    debugSyncButtons() {
        console.log('üîç Debug: Procurando bot√µes de sincroniza√ß√£o...');
        
        const elements = {
            'force-sync': document.getElementById('force-sync'),
            'sync-customers-page-btn': document.getElementById('sync-customers-page-btn'),
            'sync-status': document.getElementById('sync-status')
        };
        
        console.log('üìç Elementos encontrados:', elements);
        
        // Verificar se os event listeners est√£o ativos
        const forceSyncBtn = document.getElementById('force-sync');
        if (forceSyncBtn) {
            console.log('üñ±Ô∏è Bot√£o force-sync encontrado!');
        }
    }

    async checkAuthentication() {
        try {
            console.log('üîê Verificando autentica√ß√£o...');
            const token = localStorage.getItem('sales_manager_token');
            
            if (token) {
                const response = await api.verifyToken();
                if (response.success) {
                    this.currentUser = response.user;
                    console.log('‚úÖ Usu√°rio autenticado:', this.currentUser.username);
                    this.showMainApp();
                    return;
                }
            }
            
            this.forceShowLogin();
        } catch (error) {
            console.error('‚ùå Erro na verifica√ß√£o de autentica√ß√£o:', error);
            this.forceShowLogin();
        }
    }

    async handleLogin() {
        console.log('üîê INICIANDO LOGIN CORRIGIDO...');
        
        const username = document.getElementById('username')?.value.trim();
        const password = document.getElementById('password')?.value.trim();

        if (!username || !password) {
            this.showNotification('Por favor, preencha todos os campos', 'error');
            return;
        }

        this.showLoading(true, 'Conectando...');

        try {
            const response = await api.login(username, password);
            
            if (response && response.success) {
                this.currentUser = response.user;
                this.showMainApp();
                this.showNotification('Login realizado com sucesso!', 'success');
                
                this.loadDashboardData();
                this.loadProducts();
                this.loadCustomers();
                this.loadSales();
            } else {
                this.showNotification('Usu√°rio ou senha incorretos', 'error');
            }
        } catch (error) {
            console.error('üí• Erro no login:', error);
            this.showNotification('Erro de conex√£o: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    handleLogout() {
        console.log('üö™ Logout...');
        
        try {
            if (window.api) {
                window.api.removeToken();
            }
            this.currentUser = null;
            
            this.forceShowLogin();
            this.showNotification('Logout realizado', 'info');
        } catch (error) {
            console.error('‚ùå Erro no logout:', error);
        }
    }

    forceShowLogin() {
        console.log('üîÑ FOR√áANDO TELA DE LOGIN');
        
        try {
            const appElement = document.getElementById('app');
            const loginElement = document.getElementById('login-page');
            
            if (appElement) appElement.style.display = 'none';
            if (loginElement) {
                loginElement.style.display = 'flex';
                loginElement.classList.add('active');
            }
            
            setTimeout(() => {
                const usernameField = document.getElementById('username');
                const passwordField = document.getElementById('password');
                if (usernameField) usernameField.value = 'admin';
                if (passwordField) passwordField.value = 'admin123';
            }, 100);
        } catch (error) {
            console.error('‚ùå Erro ao for√ßar tela de login:', error);
        }
    }

    showMainApp() {
        console.log('üîÑ MOSTRANDO APLICA√á√ÉO PRINCIPAL CORRIGIDA');
        
        try {
            const loginElement = document.getElementById('login-page');
            const appElement = document.getElementById('app');
            
            if (loginElement) {
                loginElement.style.display = 'none';
                loginElement.classList.remove('active');
            }
            
            if (appElement) {
                appElement.style.display = 'block';
                appElement.classList.add('active');
            }
            
            this.updateUserInfo();
            this.showDashboard();
        } catch (error) {
            console.error('‚ùå Erro ao mostrar aplica√ß√£o principal:', error);
        }
    }

    updateUserInfo() {
        try {
            if (this.currentUser) {
                const userElement = document.getElementById('current-user');
                if (userElement) {
                    userElement.textContent = this.currentUser.full_name || this.currentUser.username;
                }
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar informa√ß√µes do usu√°rio:', error);
        }
    }

    showPage(page) {
        try {
            console.log('üìÑ Mostrando p√°gina:', page);
            
            document.querySelectorAll('.page').forEach(page => {
                page.classList.remove('active');
            });
            
            document.querySelectorAll('.menu-item').forEach(item => {
                item.classList.remove('active');
            });

            const pageElement = document.getElementById(`${page}-page`);
            const menuElement = document.querySelector(`[data-page="${page}"]`);
            
            if (pageElement) pageElement.classList.add('active');
            if (menuElement) menuElement.classList.add('active');

            this.currentPage = page;

            switch (page) {
                case 'dashboard':
                    this.loadDashboardData();
                    break;
                case 'sales':
                    this.loadSales();
                    break;
                case 'products':
                    this.loadProducts();
                    break;
                case 'customers':
                    this.loadCustomers();
                    break;
                case 'reports':
                    this.loadReports();
                    break;
            }
        } catch (error) {
            console.error('‚ùå Erro ao mostrar p√°gina:', error);
            this.showNotification('Erro ao carregar p√°gina', 'error');
        }
    }

    showDashboard() {
        this.showPage('dashboard');
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o syncCustomers COM FEEDBACK VISUAL
    async syncCustomers() {
        console.log('üîÑ App: Iniciando sincroniza√ß√£o COM FEEDBACK VISUAL...');
        
        // ‚úÖ CORRE√á√ÉO: Atualizar interface imediatamente
        this.setSyncButtonState(true);
        this.showLoading(true, 'Conectando com Garagem67...');
        
        try {
            const result = await api.syncCustomers();
            
            console.log('üì¶ Resultado da sincroniza√ß√£o:', result);
            
            if (result && result.success) {
                let message = result.message || 'Sincroniza√ß√£o conclu√≠da!';
                
                if (result.data && result.data.statistics) {
                    const stats = result.data.statistics;
                    message = `‚úÖ ${stats.synced || 0} clientes sincronizados (${stats.created} novos, ${stats.updated} atualizados)`;
                }
                
                this.showNotification(message, 'success');
                
                // ‚úÖ CORRE√á√ÉO: Atualizar dados
                await Promise.all([
                    this.loadCustomers(),
                    this.loadDashboardData()
                ]);
                
            } else {
                const errorMsg = result?.error || 'Erro desconhecido';
                this.showNotification(`‚ùå ${errorMsg}`, 'error');
            }
            
        } catch (error) {
            console.error('üí• App: Erro cr√≠tico:', error);
            this.showNotification(`üí• Erro: ${error.message}`, 'error');
        } finally {
            // ‚úÖ CORRE√á√ÉO: Restaurar interface
            this.setSyncButtonState(false);
            this.showLoading(false);
        }
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o para animar o bot√£o durante sincroniza√ß√£o
    setSyncButtonState(syncing) {
        try {
            // ‚úÖ Bot√£o do dashboard
            const forceSyncBtn = document.getElementById('force-sync');
            if (forceSyncBtn) {
                if (syncing) {
                    forceSyncBtn.classList.add('btn-syncing');
                    forceSyncBtn.innerHTML = '<i class="fas fa-spinner"></i> Sincronizando...';
                    forceSyncBtn.disabled = true;
                } else {
                    forceSyncBtn.classList.remove('btn-syncing');
                    forceSyncBtn.innerHTML = '<i class="fas fa-sync"></i> Sincronizar';
                    forceSyncBtn.disabled = false;
                }
            }

            // ‚úÖ Bot√£o da p√°gina de clientes
            const syncCustomersBtn = document.getElementById('sync-customers-page-btn');
            if (syncCustomersBtn) {
                if (syncing) {
                    syncCustomersBtn.classList.add('btn-syncing');
                    syncCustomersBtn.innerHTML = '<i class="fas fa-spinner"></i> Sincronizando...';
                    syncCustomersBtn.disabled = true;
                } else {
                    syncCustomersBtn.classList.remove('btn-syncing');
                    syncCustomersBtn.innerHTML = '<i class="fas fa-sync"></i> Sincronizar Clientes';
                    syncCustomersBtn.disabled = false;
                }
            }

            // ‚úÖ Atualizar status geral
            this.updateSyncStatus(syncing ? 'syncing' : 'success');
            
        } catch (error) {
            console.error('‚ùå Erro ao atualizar estado do bot√£o:', error);
        }
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o para atualizar o status visual
    updateSyncStatus(status) {
        try {
            const syncStatusElement = document.getElementById('sync-status');
            if (syncStatusElement) {
                syncStatusElement.className = `sync-status ${status}`;
                syncStatusElement.textContent = 
                    status === 'success' ? 'Sincronizado' : 
                    status === 'error' ? 'Erro' : 'Sincronizando';
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar status:', error);
        }
    }

    async loadDashboardData() {
        try {
            this.showLoading(true, 'Carregando dashboard...');
            
            const [statsResponse, metricsResponse] = await Promise.all([
                api.getDashboardStats(),
                api.getDashboardMetrics()
            ]);

            if (statsResponse.success) {
                this.updateDashboardStats(statsResponse.data);
            }

            if (metricsResponse.success) {
                this.updateDashboardMetrics(metricsResponse.data);
            }

        } catch (error) {
            console.error('‚ùå Erro ao carregar dashboard:', error);
            this.showNotification('Erro ao carregar dados do dashboard', 'error');
        } finally {
            this.showLoading(false);
        }
    }

    updateDashboardStats(stats) {
        try {
            if (!stats) return;
            
            const elements = {
                'total-sales': stats.sales_today?.count ?? 0,
                'total-revenue': `R$ ${(stats.sales_today?.total ?? 0).toFixed(2)}`,
                'low-stock': stats.low_stock?.length ?? 0,
                'total-customers': stats.total_customers ?? 0
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

            if (stats.recent_sales) {
                this.updateRecentSales(stats.recent_sales);
            }

            if (stats.weekly_sales) {
                this.updateSalesChart(stats.weekly_sales);
            }

        } catch (error) {
            console.error('‚ùå Erro ao atualizar estat√≠sticas:', error);
        }
    }

    updateDashboardMetrics(metrics) {
        try {
            if (!metrics) return;

            const elements = {
                'average-ticket': `R$ ${(metrics.average_ticket || 0).toFixed(2)}`,
                'conversion-rate': `${metrics.conversion_rate || 0}%`,
                'top-product': metrics.top_product || 'N/A'
            };

            Object.entries(elements).forEach(([id, value]) => {
                const element = document.getElementById(id);
                if (element) element.textContent = value;
            });

        } catch (error) {
            console.error('‚ùå Erro ao atualizar m√©tricas:', error);
        }
    }

    updateRecentSales(recentSales) {
        try {
            const container = document.getElementById('recent-sales');
            if (!container) return;

            if (!recentSales || recentSales.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <i class="fas fa-shopping-cart"></i>
                        <p>Nenhuma venda recente</p>
                    </div>
                `;
                return;
            }

            container.innerHTML = recentSales.map(sale => `
                <div class="recent-sale-item">
                    <div class="sale-info">
                        <strong>${sale.customer_name || 'Cliente n√£o identificado'}</strong>
                        <span class="sale-date">${new Date(sale.created_at).toLocaleDateString('pt-BR')}</span>
                    </div>
                    <div class="sale-amount">R$ ${parseFloat(sale.total_amount).toFixed(2)}</div>
                </div>
            `).join('');
        } catch (error) {
            console.error('‚ùå Erro ao atualizar vendas recentes:', error);
        }
    }

    updateSalesChart(weeklySales) {
        try {
            const canvas = document.getElementById('sales-chart');
            if (!canvas || !weeklySales) return;

            const ctx = canvas.getContext('2d');
            
            const labels = weeklySales.map(item => {
                const date = new Date(item.date);
                return date.toLocaleDateString('pt-BR', { weekday: 'short' });
            });
            
            const data = weeklySales.map(item => item.amount);

            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }

            if (typeof Chart !== 'undefined') {
                window.salesChartInstance = new Chart(ctx, {
                    type: 'line',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Vendas (R$)',
                            data: data,
                            borderColor: '#4361ee',
                            backgroundColor: 'rgba(67, 97, 238, 0.1)',
                            borderWidth: 2,
                            fill: true
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                ticks: {
                                    callback: function(value) {
                                        return 'R$ ' + value;
                                    }
                                }
                            }
                        }
                    }
                });
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar gr√°fico:', error);
        }
    }

    // =============================================
    // ‚úÖ M√ìDULO DE VENDAS COMPLETO E FUNCIONAL
    // =============================================

    async loadSales() {
        try {
            console.log('üõí Carregando vendas...');
            const response = await api.getSales();
            
            if (response.success) {
                this.sales = response.data || response.sales || [];
                console.log(`‚úÖ ${this.sales.length} vendas carregadas`);
                this.renderSales();
                this.updateSalesStats();
            } else {
                throw new Error(response.error || 'Erro ao carregar vendas');
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar vendas:', error);
            this.sales = [];
            this.renderSales();
            this.showNotification('Erro ao carregar vendas: ' + error.message, 'error');
        }
    }

    renderSales() {
        try {
            const tbody = document.getElementById('sales-table-body');
            if (!tbody) {
                console.log('‚ùå Tabela de vendas n√£o encontrada');
                return;
            }

            if (!this.sales || this.sales.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="8" class="empty-state">
                            <i class="fas fa-shopping-cart"></i>
                            <p>Nenhuma venda encontrada</p>
                            <button class="btn btn-primary btn-sm" onclick="app.showSaleModal()">
                                <i class="fas fa-plus"></i> Realizar Primeira Venda
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log('üé® Renderizando vendas:', this.sales);

            tbody.innerHTML = this.sales.map(sale => {
                const saleDate = new Date(sale.created_at || sale.sale_date);
                const itemsCount = sale.items_count || (sale.items ? sale.items.length : 0);
                const totalAmount = parseFloat(sale.total_amount || sale.total || 0).toFixed(2);
                const customerName = sale.customer_name || 'Cliente n√£o identificado';
                const paymentMethod = this.getPaymentMethodLabel(sale.payment_method);
                const status = this.getSaleStatus(sale.status);

                return `
                    <tr>
                        <td>
                            <strong>${sale.sale_code || 'N/A'}</strong>
                        </td>
                        <td>${customerName}</td>
                        <td>
                            ${saleDate.toLocaleDateString('pt-BR')}
                            <br><small class="text-muted">${saleDate.toLocaleTimeString('pt-BR')}</small>
                        </td>
                        <td>
                            <span class="badge badge-outline">${itemsCount} itens</span>
                        </td>
                        <td>
                            <strong>R$ ${totalAmount}</strong>
                        </td>
                        <td>${paymentMethod}</td>
                        <td>
                            <span class="badge ${status.class}">${status.text}</span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="app.viewSaleDetails(${sale.id})" title="Detalhes">
                                <i class="fas fa-eye"></i>
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="app.printSaleReceipt(${sale.id})" title="Imprimir">
                                <i class="fas fa-print"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log('‚úÖ Vendas renderizadas com sucesso');

        } catch (error) {
            console.error('‚ùå Erro ao renderizar vendas:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="8" class="empty-state error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar vendas</p>
                        <button class="btn btn-outline btn-sm" onclick="app.loadSales()">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </td>
                </tr>
            `;
        }
    }

    updateSalesStats() {
        try {
            const today = new Date().toDateString();
            const todaySales = this.sales.filter(sale => {
                const saleDate = new Date(sale.created_at || sale.sale_date).toDateString();
                return saleDate === today;
            });

            const todayCount = todaySales.length;
            const todayRevenue = todaySales.reduce((sum, sale) => 
                sum + parseFloat(sale.total_amount || sale.total || 0), 0
            );
            const avgTicket = todayCount > 0 ? todayRevenue / todayCount : 0;

            // Atualizar elementos da interface
            const countElement = document.getElementById('sales-today-count');
            const revenueElement = document.getElementById('sales-today-revenue');
            const avgElement = document.getElementById('sales-avg-ticket');

            if (countElement) countElement.textContent = todayCount;
            if (revenueElement) revenueElement.textContent = `R$ ${todayRevenue.toFixed(2)}`;
            if (avgElement) avgElement.textContent = `R$ ${avgTicket.toFixed(2)}`;

        } catch (error) {
            console.error('‚ùå Erro ao atualizar estat√≠sticas de vendas:', error);
        }
    }

    getPaymentMethodLabel(method) {
        const methods = {
            'dinheiro': 'Dinheiro',
            'cartao_credito': 'Cart√£o Cr√©dito',
            'cartao_debito': 'Cart√£o D√©bito',
            'pix': 'PIX',
            'cartao': 'Cart√£o',
            'credit': 'Cart√£o Cr√©dito',
            'debit': 'Cart√£o D√©bito'
        };
        return methods[method] || method || 'N√£o informado';
    }

    getSaleStatus(status) {
        const statusMap = {
            'completed': { class: 'badge-success', text: 'Conclu√≠da' },
            'pending': { class: 'badge-warning', text: 'Pendente' },
            'cancelled': { class: 'badge-danger', text: 'Cancelada' }
        };
        return statusMap[status] || { class: 'badge-secondary', text: 'Desconhecido' };
    }

    // ‚úÖ MODAL DE VENDA COMPLETO
    showSaleModal() {
        try {
            this.closeAllModals();
            
            const modalHtml = `
                <div class="modal-overlay active" id="sale-modal">
                    <div class="modal-content xlarge">
                        <div class="modal-header">
                            <h3>Nova Venda</h3>
                            <button type="button" class="modal-close" onclick="app.closeModal('sale-modal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="sale-container">
                                <!-- Cliente e Informa√ß√µes -->
                                <div class="sale-info-section">
                                    <div class="form-group">
                                        <label for="sale-customer">Cliente (Opcional)</label>
                                        <select id="sale-customer" class="form-control">
                                            <option value="">Selecione um cliente</option>
                                            ${this.customers.map(customer => `
                                                <option value="${customer.id}">${customer.name}</option>
                                            `).join('')}
                                        </select>
                                    </div>
                                    
                                    <div class="form-row">
                                        <div class="form-group">
                                            <label for="sale-payment">M√©todo de Pagamento *</label>
                                            <select id="sale-payment" class="form-control" required>
                                                <option value="">Selecione...</option>
                                                <option value="dinheiro">Dinheiro</option>
                                                <option value="cartao_credito">Cart√£o de Cr√©dito</option>
                                                <option value="cartao_debito">Cart√£o de D√©bito</option>
                                                <option value="pix">PIX</option>
                                            </select>
                                        </div>
                                        
                                        <div class="form-group">
                                            <label for="sale-observations">Observa√ß√µes</label>
                                            <input type="text" id="sale-observations" class="form-control" placeholder="Observa√ß√µes opcionais...">
                                        </div>
                                    </div>
                                </div>

                                <!-- Adicionar Produtos -->
                                <div class="sale-products-section">
                                    <div class="section-header">
                                        <h4>Produtos da Venda</h4>
                                        <button type="button" class="btn btn-outline btn-sm" onclick="app.showProductSelectionModal()">
                                            <i class="fas fa-plus"></i> Adicionar Produto
                                        </button>
                                    </div>
                                    
                                    <div class="sale-items-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Produto</th>
                                                    <th>Quantidade</th>
                                                    <th>Pre√ßo Unit.</th>
                                                    <th>Total</th>
                                                    <th>A√ß√µes</th>
                                                </tr>
                                            </thead>
                                            <tbody id="sale-items-body">
                                                <tr>
                                                    <td colspan="5" class="empty-state">
                                                        <i class="fas fa-boxes"></i>
                                                        <p>Nenhum produto adicionado</p>
                                                    </td>
                                                </tr>
                                            </tbody>
                                        </table>
                                    </div>
                                </div>

                                <!-- Resumo e Total -->
                                <div class="sale-summary-section">
                                    <div class="sale-totals">
                                        <div class="total-line">
                                            <span>Subtotal:</span>
                                            <span id="sale-subtotal">R$ 0,00</span>
                                        </div>
                                        <div class="total-line">
                                            <span>Total:</span>
                                            <span id="sale-total-amount" class="total-amount">R$ 0,00</span>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('sale-modal')">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="app.finalizeSale()">
                                <i class="fas fa-check"></i> Finalizar Venda
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            // Inicializar a venda
            this.currentSale = {
                items: [],
                customer_id: null,
                payment_method: '',
                observations: ''
            };
            
            this.renderSaleItems();
            
        } catch (error) {
            console.error('‚ùå Erro ao abrir modal de venda:', error);
            this.showNotification('Erro ao abrir formul√°rio de venda', 'error');
        }
    }

    showProductSelectionModal() {
        try {
            this.closeModal('product-selection-modal');

            const availableProducts = this.products.filter(p => p.is_active === 1 && (p.current_stock > 0));
            
            const modalHtml = `
                <div class="modal-overlay active" id="product-selection-modal">
                    <div class="modal-content large">
                        <div class="modal-header">
                            <h3>Selecionar Produtos (${availableProducts.length} dispon√≠veis)</h3>
                            <div class="header-actions">
                                <button type="button" class="btn btn-outline btn-sm" onclick="app.closeModal('product-selection-modal')">
                                    <i class="fas fa-arrow-left"></i> Voltar para Venda
                                </button>
                                <button type="button" class="modal-close" onclick="app.closeModal('product-selection-modal')">
                                    <i class="fas fa-times"></i>
                                </button>
                            </div>
                        </div>
                        <div class="modal-body">
                            <div class="form-group">
                                <input type="text" id="product-search-modal" class="form-control" 
                                       placeholder="Digite para buscar produtos..." onkeyup="app.filterProductsModal(this.value)">
                            </div>
                            
                            <div class="products-grid-modal" id="products-modal-list">
                                ${availableProducts.map(product => `
                                    <div class="product-card-modal" onclick="app.addProductToSale(${product.id})">
                                        <div class="product-info">
                                            <strong>${product.name}</strong>
                                            ${product.description ? `<div class="product-description">${product.description}</div>` : ''}
                                            <div class="product-details">
                                                <span class="stock ${product.current_stock < 10 ? 'low-stock' : ''}">
                                                    Estoque: ${product.current_stock}
                                                </span>
                                                <span class="price">R$ ${parseFloat(product.price).toFixed(2)}</span>
                                            </div>
                                        </div>
                                        <div class="product-action">
                                            <i class="fas fa-plus"></i>
                                        </div>
                                    </div>
                                `).join('')}
                                
                                ${availableProducts.length === 0 ? `
                                    <div class="empty-state">
                                        <i class="fas fa-boxes"></i>
                                        <p>Nenhum produto dispon√≠vel em estoque</p>
                                        <button class="btn btn-primary btn-sm" onclick="app.closeModal('product-selection-modal')">
                                            <i class="fas fa-arrow-left"></i> Voltar
                                        </button>
                                    </div>
                                ` : ''}
                            </div>
                        </div>
                        <div class="modal-footer">
                            <div class="selection-stats">
                                <strong>${this.currentSale.items.length} produtos</strong> adicionados √† venda
                            </div>
                            <button type="button" class="btn btn-primary" onclick="app.closeModal('product-selection-modal')">
                                <i class="fas fa-check"></i> Concluir Sele√ß√£o
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

            setTimeout(() => {
                const searchField = document.getElementById('product-search-modal');
                if (searchField) searchField.focus();
            }, 200);

        } catch (error) {
            console.error('‚ùå Erro ao abrir modal de sele√ß√£o:', error);
            this.showNotification('Erro ao abrir sele√ß√£o de produtos', 'error');
        }
    }

    filterProductsModal(searchTerm) {
        try {
            const productCards = document.querySelectorAll('.product-card-modal');
            const searchLower = searchTerm.toLowerCase();
            
            productCards.forEach(card => {
                const productName = card.querySelector('strong').textContent.toLowerCase();
                const productDescription = card.querySelector('.product-description')?.textContent.toLowerCase() || '';
                
                if (productName.includes(searchLower) || productDescription.includes(searchLower)) {
                    card.style.display = 'flex';
                } else {
                    card.style.display = 'none';
                }
            });
        } catch (error) {
            console.error('‚ùå Erro ao filtrar produtos:', error);
        }
    }

    addProductToSale(productId) {
        try {
            const product = this.products.find(p => p.id === productId);
            if (!product) {
                this.showNotification('Produto n√£o encontrado', 'error');
                return;
            }

            if (product.current_stock <= 0) {
                this.showNotification('Produto sem estoque dispon√≠vel', 'error');
                return;
            }

            // Verificar se o produto j√° est√° na venda
            const existingItemIndex = this.currentSale.items.findIndex(item => item.product_id === productId);
            
            if (existingItemIndex >= 0) {
                // Aumentar quantidade se houver estoque
                const currentItem = this.currentSale.items[existingItemIndex];
                if (currentItem.quantity < product.current_stock) {
                    currentItem.quantity += 1;
                    currentItem.total = currentItem.quantity * currentItem.unit_price;
                    this.showNotification(`${product.name} quantidade aumentada para ${currentItem.quantity}`, 'success');
                } else {
                    this.showNotification('Estoque insuficiente para este produto', 'error');
                    return;
                }
            } else {
                // Adicionar novo item
                this.currentSale.items.push({
                    product_id: product.id,
                    product_name: product.name,
                    quantity: 1,
                    unit_price: parseFloat(product.price),
                    total: parseFloat(product.price)
                });
                this.showNotification(`${product.name} adicionado √† venda`, 'success');
            }

            this.renderSaleItems();
            this.updateSaleTotal();

            setTimeout(() => {
                const searchField = document.getElementById('product-search-modal');
                if (searchField) searchField.focus();
            }, 100);

        } catch (error) {
            console.error('‚ùå Erro ao adicionar produto √† venda:', error);
            this.showNotification('Erro ao adicionar produto', 'error');
        }
    }

    renderSaleItems() {
        try {
            const tbody = document.getElementById('sale-items-body');
            if (!tbody) return;

            if (!this.currentSale.items || this.currentSale.items.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="5" class="empty-state">
                            <i class="fas fa-boxes"></i>
                            <p>Nenhum produto adicionado</p>
                            <small>Clique em "Adicionar Produto" para come√ßar</small>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = this.currentSale.items.map((item, index) => {
                const product = this.products.find(p => p.id === item.product_id);
                const maxQuantity = product ? product.current_stock : 0;
                const isLowStock = maxQuantity < 10;

                return `
                    <tr>
                        <td>
                            <strong>${item.product_name}</strong>
                            <br>
                            <small class="text-muted ${isLowStock ? 'text-warning' : ''}">
                                Estoque: ${maxQuantity} ${isLowStock ? '‚ö†Ô∏è' : ''}
                            </small>
                        </td>
                        <td>
                            <div class="quantity-controls">
                                <button type="button" class="qty-btn" onclick="app.updateSaleItemQuantity(${index}, ${item.quantity - 1})" 
                                        ${item.quantity <= 1 ? 'disabled' : ''}>
                                    <i class="fas fa-minus"></i>
                                </button>
                                <input type="number" class="qty-input" value="${item.quantity}" min="1" max="${maxQuantity}"
                                       onchange="app.updateSaleItemQuantity(${index}, parseInt(this.value))"
                                       onblur="app.validateSaleItemQuantity(${index}, this)">
                                <button type="button" class="qty-btn" onclick="app.updateSaleItemQuantity(${index}, ${item.quantity + 1})"
                                        ${item.quantity >= maxQuantity ? 'disabled' : ''}>
                                    <i class="fas fa-plus"></i>
                                </button>
                            </div>
                        </td>
                        <td>R$ ${item.unit_price.toFixed(2)}</td>
                        <td><strong>R$ ${item.total.toFixed(2)}</strong></td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="app.removeSaleItem(${index})" title="Remover">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

        } catch (error) {
            console.error('‚ùå Erro ao renderizar itens da venda:', error);
        }
    }

    updateSaleItemQuantity(itemIndex, newQuantity) {
        try {
            const item = this.currentSale.items[itemIndex];
            const product = this.products.find(p => p.id === item.product_id);
            
            if (!product) {
                this.showNotification('Produto n√£o encontrado', 'error');
                return;
            }

            if (newQuantity < 1) {
                newQuantity = 1;
            }

            if (newQuantity > product.current_stock) {
                this.showNotification(`Quantidade indispon√≠vel. Estoque: ${product.current_stock}`, 'error');
                return;
            }

            item.quantity = newQuantity;
            item.total = item.quantity * item.unit_price;

            this.renderSaleItems();
            this.updateSaleTotal();

        } catch (error) {
            console.error('‚ùå Erro ao atualizar quantidade:', error);
            this.showNotification('Erro ao atualizar quantidade', 'error');
        }
    }

    validateSaleItemQuantity(itemIndex, inputElement) {
        try {
            const newQuantity = parseInt(inputElement.value);
            this.updateSaleItemQuantity(itemIndex, newQuantity);
        } catch (error) {
            console.error('‚ùå Erro ao validar quantidade:', error);
        }
    }

    removeSaleItem(itemIndex) {
        try {
            const item = this.currentSale.items[itemIndex];
            this.currentSale.items.splice(itemIndex, 1);
            this.renderSaleItems();
            this.updateSaleTotal();
            this.showNotification(`${item.product_name} removido da venda`, 'info');
        } catch (error) {
            console.error('‚ùå Erro ao remover item:', error);
            this.showNotification('Erro ao remover produto', 'error');
        }
    }

    updateSaleTotal() {
        try {
            const subtotal = this.currentSale.items.reduce((sum, item) => sum + item.total, 0);
            
            const subtotalElement = document.getElementById('sale-subtotal');
            const totalElement = document.getElementById('sale-total-amount');
            
            if (subtotalElement) subtotalElement.textContent = `R$ ${subtotal.toFixed(2)}`;
            if (totalElement) totalElement.textContent = `R$ ${subtotal.toFixed(2)}`;

        } catch (error) {
            console.error('‚ùå Erro ao calcular total:', error);
        }
    }

    async finalizeSale() {
        try {
            // Coletar dados do formul√°rio
            const customerSelect = document.getElementById('sale-customer');
            const paymentSelect = document.getElementById('sale-payment');
            const observationsInput = document.getElementById('sale-observations');

            this.currentSale.customer_id = customerSelect?.value ? parseInt(customerSelect.value) : null;
            this.currentSale.payment_method = paymentSelect?.value || '';
            this.currentSale.observations = observationsInput?.value || '';

            // Valida√ß√µes
            if (!this.currentSale.payment_method) {
                this.showNotification('Selecione o m√©todo de pagamento', 'error');
                return;
            }

            if (this.currentSale.items.length === 0) {
                this.showNotification('Adicione pelo menos um produto √† venda', 'error');
                return;
            }

            // Validar estoque
            for (const item of this.currentSale.items) {
                const product = this.products.find(p => p.id === item.product_id);
                if (!product) {
                    this.showNotification(`Produto "${item.product_name}" n√£o encontrado`, 'error');
                    return;
                }
                if (item.quantity > product.current_stock) {
                    this.showNotification(`Estoque insuficiente para "${item.product_name}". Dispon√≠vel: ${product.current_stock}`, 'error');
                    return;
                }
            }

            console.log('üì§ Finalizando venda:', this.currentSale);

            this.showLoading(true, 'Processando venda...');

            const result = await api.createSale(this.currentSale);
            
            if (result && result.success) {
                this.showNotification('Venda realizada com sucesso!', 'success');
                this.closeModal('sale-modal');
                
                // Recarregar dados
                await this.loadSales();
                await this.loadProducts();
                await this.loadDashboardData();
                
            } else {
                throw new Error(result?.error || 'Erro desconhecido ao processar venda');
            }

        } catch (error) {
            console.error('‚ùå Erro ao finalizar venda:', error);
            this.showNotification('Erro ao finalizar venda: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    async viewSaleDetails(saleId) {
        try {
            console.log('üëÄ Visualizando venda:', saleId);
            
            this.showLoading(true, 'Carregando detalhes da venda...');
            
            const response = await api.getSaleById(saleId);
            
            if (response.success) {
                this.showSaleDetailsModal(response.data);
            } else {
                throw new Error(response.error || 'Erro ao carregar venda');
            }
        } catch (error) {
            console.error('‚ùå Erro ao visualizar venda:', error);
            this.showNotification('Erro ao carregar detalhes da venda', 'error');
        } finally {
            this.showLoading(false);
        }
    }

    showSaleDetailsModal(sale) {
        try {
            this.closeAllModals();

            const modalHtml = `
                <div class="modal-overlay active" id="sale-details-modal">
                    <div class="modal-content large">
                        <div class="modal-header">
                            <h3>Detalhes da Venda #${sale.sale_code}</h3>
                            <button type="button" class="modal-close" onclick="app.closeModal('sale-details-modal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <div class="sale-details">
                                <div class="detail-section">
                                    <h4>Informa√ß√µes da Venda</h4>
                                    <div class="detail-grid">
                                        <div class="detail-item">
                                            <label>Data:</label>
                                            <span>${new Date(sale.created_at).toLocaleString('pt-BR')}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Cliente:</label>
                                            <span>${sale.customer_name || 'N√£o informado'}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Pagamento:</label>
                                            <span>${this.getPaymentMethodLabel(sale.payment_method)}</span>
                                        </div>
                                        <div class="detail-item">
                                            <label>Total:</label>
                                            <span class="total-amount">R$ ${parseFloat(sale.total_amount).toFixed(2)}</span>
                                        </div>
                                    </div>
                                </div>

                                <div class="detail-section">
                                    <h4>Itens da Venda</h4>
                                    <div class="table-container">
                                        <table class="data-table">
                                            <thead>
                                                <tr>
                                                    <th>Produto</th>
                                                    <th>Quantidade</th>
                                                    <th>Pre√ßo Unit.</th>
                                                    <th>Total</th>
                                                </tr>
                                            </thead>
                                            <tbody>
                                                ${(sale.items || []).map(item => `
                                                    <tr>
                                                        <td>${item.product_name}</td>
                                                        <td>${item.quantity}</td>
                                                        <td>R$ ${parseFloat(item.unit_price).toFixed(2)}</td>
                                                        <td>R$ ${parseFloat(item.total_price || item.quantity * item.unit_price).toFixed(2)}</td>
                                                    </tr>
                                                `).join('')}
                                            </tbody>
                                        </table>
                                    </div>
                                </div>
                            </div>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('sale-details-modal')">
                                Fechar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="app.printSaleReceipt(${sale.id})">
                                <i class="fas fa-print"></i> Imprimir Comprovante
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);

        } catch (error) {
            console.error('‚ùå Erro ao mostrar detalhes da venda:', error);
            this.showNotification('Erro ao exibir detalhes', 'error');
        }
    }

    async printSaleReceipt(saleId) {
        try {
            console.log('üñ®Ô∏è Gerando comprovante para venda:', saleId);
            
            this.showLoading(true, 'Gerando comprovante...');
            
            const response = await api.getSaleById(saleId);
            
            if (response.success) {
                const sale = response.data;
                this.showPrintReceiptModal(sale);
            } else {
                throw new Error(response.error || 'Erro ao carregar venda para impress√£o');
            }
        } catch (error) {
            console.error('‚ùå Erro ao gerar comprovante:', error);
            this.showNotification('Erro ao gerar comprovante: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    showPrintReceiptModal(sale) {
        try {
            this.closeAllModals();

            const receiptHtml = `
                <div class="modal-overlay active" id="print-receipt-modal">
                    <div class="modal-content print-receipt">
                        <div class="receipt-header">
                            <div class="receipt-logo">
                                <i class="fas fa-store"></i>
                                <h2>Garagem 67</h2>
                            </div>
                            <p>Bar e Conveni√™ncia</p>
                            <p>CNPJ: 12.345.678/0001-99</p>
                            <p>Endere√ßo: Rua Exemplo, 123 - Centro</p>
                            <p>Telefone: (67) 99999-9999</p>
                        </div>
                        
                        <div class="receipt-body">
                            <div class="receipt-info">
                                <h3>COMPROVANTE DE VENDA</h3>
                                <div class="receipt-details">
                                    <div class="receipt-row">
                                        <span class="label">C√≥digo:</span>
                                        <span class="value">${sale.sale_code || 'N/A'}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span class="label">Data:</span>
                                        <span class="value">${new Date(sale.created_at).toLocaleString('pt-BR')}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span class="label">Cliente:</span>
                                        <span class="value">${sale.customer_name || 'Consumidor'}</span>
                                    </div>
                                    <div class="receipt-row">
                                        <span class="label">Pagamento:</span>
                                        <span class="value">${this.getPaymentMethodLabel(sale.payment_method)}</span>
                                    </div>
                                </div>
                            </div>

                            <div class="receipt-items">
                                <table class="receipt-table">
                                    <thead>
                                        <tr>
                                            <th>Produto</th>
                                            <th>Qtd</th>
                                            <th>Pre√ßo</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        ${(sale.items || []).map(item => `
                                            <tr>
                                                <td class="product-name">${item.product_name}</td>
                                                <td class="quantity">${item.quantity}</td>
                                                <td class="price">R$ ${parseFloat(item.unit_price).toFixed(2)}</td>
                                                <td class="total">R$ ${parseFloat(item.total_price || item.quantity * item.unit_price).toFixed(2)}</td>
                                            </tr>
                                        `).join('')}
                                    </tbody>
                                </table>
                            </div>

                            <div class="receipt-totals">
                                <div class="receipt-row total">
                                    <span class="label">TOTAL:</span>
                                    <span class="value">R$ ${parseFloat(sale.total_amount).toFixed(2)}</span>
                                </div>
                            </div>

                            ${sale.observations ? `
                                <div class="receipt-observations">
                                    <strong>Observa√ß√µes:</strong>
                                    <p>${sale.observations}</p>
                                </div>
                            ` : ''}
                        </div>

                        <div class="receipt-footer">
                            <p>Obrigado pela prefer√™ncia!</p>
                            <p>Volte sempre!</p>
                            <div class="receipt-qr">
                                <div class="qr-placeholder">
                                    <i class="fas fa-qrcode"></i>
                                    <span>C√≥digo da Venda: ${sale.sale_code}</span>
                                </div>
                            </div>
                        </div>

                        <div class="receipt-actions">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('print-receipt-modal')">
                                Fechar
                            </button>
                            <button type="button" class="btn btn-primary" onclick="app.printReceipt()">
                                <i class="fas fa-print"></i> Imprimir
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', receiptHtml);

        } catch (error) {
            console.error('‚ùå Erro ao mostrar comprovante:', error);
            this.showNotification('Erro ao gerar comprovante', 'error');
        }
    }

    printReceipt() {
        try {
            const receiptElement = document.querySelector('.print-receipt');
            if (!receiptElement) {
                this.showNotification('Comprovante n√£o encontrado', 'error');
                return;
            }

            // Criar uma nova janela para impress√£o
            const printWindow = window.open('', '_blank');
            const receiptContent = receiptElement.innerHTML;
            
            printWindow.document.write(`
                <!DOCTYPE html>
                <html>
                <head>
                    <title>Comprovante de Venda - Garagem 67</title>
                    <style>
                        body {
                            font-family: 'Courier New', monospace;
                            margin: 0;
                            padding: 10px;
                            font-size: 12px;
                            color: #000;
                        }
                        .print-receipt {
                            width: 80mm;
                            max-width: 80mm;
                            margin: 0 auto;
                        }
                        .receipt-header {
                            text-align: center;
                            border-bottom: 1px dashed #000;
                            padding-bottom: 10px;
                            margin-bottom: 10px;
                        }
                        .receipt-logo {
                            display: flex;
                            align-items: center;
                            justify-content: center;
                            gap: 8px;
                            margin-bottom: 5px;
                        }
                        .receipt-logo i {
                            font-size: 20px;
                            color: #4361ee;
                        }
                        .receipt-logo h2 {
                            margin: 0;
                            font-size: 16px;
                            color: #4361ee;
                        }
                        .receipt-header p {
                            margin: 2px 0;
                            font-size: 10px;
                        }
                        .receipt-info h3 {
                            text-align: center;
                            margin: 10px 0;
                            font-size: 12px;
                            border-bottom: 1px solid #000;
                            padding-bottom: 5px;
                        }
                        .receipt-details {
                            margin-bottom: 10px;
                        }
                        .receipt-row {
                            display: flex;
                            justify-content: space-between;
                            margin: 3px 0;
                        }
                        .receipt-row.total {
                            border-top: 2px solid #000;
                            padding-top: 5px;
                            margin-top: 5px;
                            font-weight: bold;
                            font-size: 14px;
                        }
                        .receipt-table {
                            width: 100%;
                            border-collapse: collapse;
                            margin: 10px 0;
                        }
                        .receipt-table th {
                            border-bottom: 1px solid #000;
                            padding: 4px 2px;
                            text-align: left;
                            font-weight: bold;
                        }
                        .receipt-table td {
                            padding: 3px 2px;
                            border-bottom: 1px dashed #ddd;
                        }
                        .product-name {
                            max-width: 40mm;
                            overflow: hidden;
                            text-overflow: ellipsis;
                            white-space: nowrap;
                        }
                        .quantity, .price, .total {
                            text-align: center;
                            width: 15mm;
                        }
                        .receipt-observations {
                            margin: 10px 0;
                            padding: 5px;
                            border: 1px dashed #000;
                            font-size: 10px;
                        }
                        .receipt-footer {
                            text-align: center;
                            margin-top: 15px;
                            border-top: 1px dashed #000;
                            padding-top: 10px;
                        }
                        .receipt-qr {
                            margin: 10px 0;
                        }
                        .qr-placeholder {
                            border: 1px dashed #000;
                            padding: 10px;
                            text-align: center;
                            font-size: 10px;
                        }
                        .receipt-actions {
                            display: none;
                        }
                        @media print {
                            body {
                                margin: 0;
                                padding: 0;
                            }
                            .print-receipt {
                                width: 80mm !important;
                                max-width: 80mm !important;
                            }
                        }
                    </style>
                </head>
                <body>
                    <div class="print-receipt">
                        ${receiptContent}
                    </div>
                    <script>
                        window.onload = function() {
                            window.print();
                            setTimeout(function() {
                                window.close();
                            }, 1000);
                        };
                    </script>
                </body>
                </html>
            `);

            printWindow.document.close();

        } catch (error) {
            console.error('‚ùå Erro ao imprimir comprovante:', error);
            this.showNotification('Erro ao imprimir comprovante', 'error');
        }
    }

    // =============================================
    // M√ìDULO DE PRODUTOS
    // =============================================

    async loadProducts() {
        try {
            console.log('üì¶ Carregando produtos...');
            const response = await api.getProducts();
            
            if (response.success) {
                this.products = response.products || response.data || [];
                console.log(`‚úÖ ${this.products.length} produtos carregados`);
                this.renderProducts();
            } else {
                throw new Error(response.error || 'Erro ao carregar produtos');
            }
        } catch (error) {
            console.error('‚ùå Erro ao carregar produtos:', error);
            this.products = [];
            this.renderProducts();
            this.showNotification('Erro ao carregar produtos: ' + error.message, 'error');
        }
    }

    renderProducts() {
        try {
            const tbody = document.getElementById('products-table-body');
            if (!tbody) {
                console.log('‚ùå Tabela de produtos n√£o encontrada');
                return;
            }

            if (!this.products || this.products.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="6" class="empty-state">
                            <i class="fas fa-boxes"></i>
                            <p>Nenhum produto cadastrado</p>
                            <button class="btn btn-primary btn-sm" onclick="app.showProductModal()">
                                <i class="fas fa-plus"></i> Cadastrar Primeiro Produto
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            console.log('üé® Renderizando produtos:', this.products);

            tbody.innerHTML = this.products.map(product => {
                const stock = product.current_stock || product.available_stock || 0;
                const category = product.category_name || 'Geral';
                const price = parseFloat(product.price || 0).toFixed(2);
                
                return `
                    <tr>
                        <td>
                            <strong>${product.name || 'Sem nome'}</strong>
                            ${product.description ? `<br><small class="text-muted">${product.description}</small>` : ''}
                        </td>
                        <td>${category}</td>
                        <td>R$ ${price}</td>
                        <td>
                            <span class="${stock < 10 ? 'text-warning' : 'text-success'}">
                                <strong>${stock}</strong>
                            </span>
                        </td>
                        <td>
                            <span class="badge ${product.is_active === 1 ? 'badge-success' : 'badge-secondary'}">
                                ${product.is_active === 1 ? 'Ativo' : 'Inativo'}
                            </span>
                        </td>
                        <td>
                            <button class="btn btn-outline btn-sm" onclick="app.editProduct(${product.id})" title="Editar">
                                <i class="fas fa-edit"></i>
                            </button>
                            <button class="btn btn-outline btn-sm" onclick="app.deleteProduct(${product.id})" title="Excluir">
                                <i class="fas fa-trash"></i>
                            </button>
                        </td>
                    </tr>
                `;
            }).join('');

            console.log('‚úÖ Produtos renderizados com sucesso');

        } catch (error) {
            console.error('‚ùå Erro ao renderizar produtos:', error);
            tbody.innerHTML = `
                <tr>
                    <td colspan="6" class="empty-state error">
                        <i class="fas fa-exclamation-triangle"></i>
                        <p>Erro ao carregar produtos</p>
                        <button class="btn btn-outline btn-sm" onclick="app.loadProducts()">
                            <i class="fas fa-redo"></i> Tentar Novamente
                        </button>
                    </td>
                </tr>
            `;
        }
    }

    showProductModal() {
        try {
            this.closeAllModals();
            
            const modalHtml = `
                <div class="modal-overlay active" id="product-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Novo Produto</h3>
                            <button type="button" class="modal-close" onclick="app.closeModal('product-modal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="product-form">
                                <div class="form-group">
                                    <label for="product-name">Nome do Produto *</label>
                                    <input type="text" id="product-name" class="form-control" placeholder="Ex: Coca-Cola 350ml" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-price">Pre√ßo (R$) *</label>
                                    <input type="number" id="product-price" class="form-control" step="0.01" min="0.01" placeholder="0.00" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-stock">Estoque Inicial *</label>
                                    <input type="number" id="product-stock" class="form-control" min="0" value="0" required>
                                </div>
                                <div class="form-group">
                                    <label for="product-category">Categoria *</label>
                                    <select id="product-category" class="form-control" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="1">Bebidas</option>
                                        <option value="2">Snacks</option>
                                        <option value="3">Tabacaria</option>
                                        <option value="4">Conveni√™ncia</option>
                                        <option value="5">Outros</option>
                                    </select>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('product-modal')">Cancelar</button>
                            <button type="button" class="btn btn-primary" onclick="app.createProduct()">
                                <i class="fas fa-save"></i> Salvar Produto
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            setTimeout(() => {
                const nameField = document.getElementById('product-name');
                if (nameField) nameField.focus();
            }, 100);
            
        } catch (error) {
            console.error('‚ùå Erro ao abrir modal de produto:', error);
            this.showNotification('Erro ao abrir formul√°rio', 'error');
        }
    }

    async createProduct() {
        try {
            const name = document.getElementById('product-name')?.value.trim();
            const price = parseFloat(document.getElementById('product-price')?.value);
            const stock = parseInt(document.getElementById('product-stock')?.value) || 0;
            const category_id = parseInt(document.getElementById('product-category')?.value);

            console.log('üìù Dados do produto:', { name, price, stock, category_id });

            if (!name) {
                this.showNotification('Nome do produto √© obrigat√≥rio', 'error');
                return;
            }

            if (isNaN(price) || price <= 0) {
                this.showNotification('Pre√ßo deve ser maior que zero', 'error');
                return;
            }

            if (isNaN(stock) || stock < 0) {
                this.showNotification('Estoque deve ser um n√∫mero positivo', 'error');
                return;
            }

            if (isNaN(category_id) || category_id <= 0) {
                this.showNotification('Selecione uma categoria v√°lida', 'error');
                return;
            }

            const productData = {
                name: name,
                price: price,
                category_id: category_id,
                stock_initial: stock
            };

            console.log('üì§ Enviando produto:', productData);

            this.showLoading(true, 'Salvando produto...');

            const result = await api.createProduct(productData);
            
            if (result && result.success) {
                this.showNotification('Produto criado com sucesso!', 'success');
                this.closeModal('product-modal');
                
                await this.loadProducts();
                this.loadDashboardData();
            } else {
                throw new Error(result?.error || 'Erro desconhecido');
            }
        } catch (error) {
            console.error('‚ùå Erro ao criar produto:', error);
            this.showNotification('Erro ao criar produto: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    async editProduct(productId) {
        try {
            console.log('‚úèÔ∏è Editando produto:', productId);
            
            this.showLoading(true, 'Carregando dados do produto...');
            
            const response = await api.getProductById(productId);
            
            if (response.success) {
                const product = response.data;
                this.showEditProductModal(product);
            } else {
                throw new Error(response.error || 'Erro ao carregar produto');
            }
        } catch (error) {
            console.error('‚ùå Erro ao editar produto:', error);
            this.showNotification('Erro ao carregar produto: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    showEditProductModal(product) {
        try {
            this.closeAllModals();
            
            const modalHtml = `
                <div class="modal-overlay active" id="edit-product-modal">
                    <div class="modal-content">
                        <div class="modal-header">
                            <h3>Editar Produto</h3>
                            <button type="button" class="modal-close" onclick="app.closeModal('edit-product-modal')">
                                <i class="fas fa-times"></i>
                            </button>
                        </div>
                        <div class="modal-body">
                            <form id="edit-product-form">
                                <input type="hidden" id="edit-product-id" value="${product.id}">
                                <div class="form-group">
                                    <label for="edit-product-name">Nome do Produto *</label>
                                    <input type="text" id="edit-product-name" class="form-control" 
                                           value="${product.name || ''}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-price">Pre√ßo (R$) *</label>
                                    <input type="number" id="edit-product-price" class="form-control" 
                                           step="0.01" min="0.01" value="${parseFloat(product.price || 0).toFixed(2)}" required>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-stock">Estoque Atual</label>
                                    <input type="number" id="edit-product-stock" class="form-control" 
                                           min="0" value="${product.current_stock || 0}" readonly
                                           style="background-color: #f8f9fa;">
                                    <small class="text-muted">Para alterar o estoque, use a p√°gina de invent√°rio</small>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-category">Categoria *</label>
                                    <select id="edit-product-category" class="form-control" required>
                                        <option value="">Selecione uma categoria</option>
                                        <option value="1" ${product.category_id == 1 ? 'selected' : ''}>Bebidas</option>
                                        <option value="2" ${product.category_id == 2 ? 'selected' : ''}>Snacks</option>
                                        <option value="3" ${product.category_id == 3 ? 'selected' : ''}>Tabacaria</option>
                                        <option value="4" ${product.category_id == 4 ? 'selected' : ''}>Conveni√™ncia</option>
                                        <option value="5" ${product.category_id == 5 ? 'selected' : ''}>Outros</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label for="edit-product-description">Descri√ß√£o</label>
                                    <textarea id="edit-product-description" class="form-control" 
                                              rows="3" placeholder="Descri√ß√£o opcional do produto">${product.description || ''}</textarea>
                                </div>
                                <div class="form-group">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="edit-product-active" ${product.is_active === 1 ? 'checked' : ''}>
                                        <span class="checkmark"></span>
                                        Produto ativo
                                    </label>
                                </div>
                            </form>
                        </div>
                        <div class="modal-footer">
                            <button type="button" class="btn btn-outline" onclick="app.closeModal('edit-product-modal')">
                                Cancelar
                            </button>
                            <button type="button" class="btn btn-danger" onclick="app.deleteProduct(${product.id})" 
                                    style="margin-right: auto;">
                                <i class="fas fa-trash"></i> Excluir
                            </button>
                            <button type="button" class="btn btn-primary" onclick="app.updateProduct()">
                                <i class="fas fa-save"></i> Atualizar Produto
                            </button>
                        </div>
                    </div>
                </div>
            `;

            document.body.insertAdjacentHTML('beforeend', modalHtml);
            
            setTimeout(() => {
                const nameField = document.getElementById('edit-product-name');
                if (nameField) nameField.focus();
            }, 100);
            
        } catch (error) {
            console.error('‚ùå Erro ao abrir modal de edi√ß√£o:', error);
            this.showNotification('Erro ao abrir formul√°rio de edi√ß√£o', 'error');
        }
    }

    async updateProduct() {
        try {
            const productId = document.getElementById('edit-product-id')?.value;
            const name = document.getElementById('edit-product-name')?.value.trim();
            const price = parseFloat(document.getElementById('edit-product-price')?.value);
            const category_id = parseInt(document.getElementById('edit-product-category')?.value);
            const description = document.getElementById('edit-product-description')?.value.trim();
            const is_active = document.getElementById('edit-product-active')?.checked ? 1 : 0;

            console.log('üìù Dados do produto para atualizar:', { 
                productId, name, price, category_id, description, is_active 
            });

            if (!name) {
                this.showNotification('Nome do produto √© obrigat√≥rio', 'error');
                return;
            }

            if (isNaN(price) || price <= 0) {
                this.showNotification('Pre√ßo deve ser maior que zero', 'error');
                return;
            }

            if (isNaN(category_id) || category_id <= 0) {
                this.showNotification('Selecione uma categoria v√°lida', 'error');
                return;
            }

            const productData = {
                name: name,
                price: price,
                category_id: category_id,
                description: description,
                is_active: is_active
            };

            console.log('üì§ Atualizando produto:', productData);

            this.showLoading(true, 'Atualizando produto...');

            const result = await api.updateProduct(productId, productData);
            
            if (result && result.success) {
                this.showNotification('Produto atualizado com sucesso!', 'success');
                this.closeModal('edit-product-modal');
                
                await this.loadProducts();
                
            } else {
                throw new Error(result?.error || 'Erro desconhecido ao atualizar');
            }
        } catch (error) {
            console.error('‚ùå Erro ao atualizar produto:', error);
            this.showNotification('Erro ao atualizar produto: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    async deleteProduct(productId) {
        try {
            const product = this.products.find(p => p.id === productId);
            if (!product) {
                this.showNotification('Produto n√£o encontrado', 'error');
                return;
            }

            const confirmMessage = `Tem certeza que deseja excluir o produto "${product.name}"?\n\nEsta a√ß√£o n√£o pode ser desfeita.`;
            
            if (!confirm(confirmMessage)) {
                return;
            }

            this.showLoading(true, 'Excluindo produto...');

            const result = await api.deleteProduct(productId);
            
            if (result && result.success) {
                this.showNotification('Produto exclu√≠do com sucesso!', 'success');
                this.closeModal('edit-product-modal');
                
                await this.loadProducts();
                
            } else {
                throw new Error(result?.error || 'Erro desconhecido ao excluir');
            }
        } catch (error) {
            console.error('‚ùå Erro ao excluir produto:', error);
            this.showNotification('Erro ao excluir produto: ' + error.message, 'error');
        } finally {
            this.showLoading(false);
        }
    }

    // =============================================
    // M√ìDULO DE CLIENTES
    // =============================================

    async loadCustomers() {
        try {
            this.customers = [
                {
                    id: 1,
                    name: 'Cliente Exemplo 1',
                    email: 'cliente1@email.com',
                    phone: '(67) 99999-9999',
                    last_sync: new Date().toISOString()
                },
                {
                    id: 2,
                    name: 'Cliente Exemplo 2',
                    email: 'cliente2@email.com', 
                    phone: '(67) 98888-8888',
                    last_sync: new Date().toISOString()
                }
            ];
            this.renderCustomers();
        } catch (error) {
            console.error('‚ùå Erro ao carregar clientes:', error);
            this.customers = [];
            this.renderCustomers();
        }
    }

    renderCustomers() {
        try {
            const tbody = document.getElementById('customers-table-body');
            if (!tbody) return;

            if (this.customers.length === 0) {
                tbody.innerHTML = `
                    <tr>
                        <td colspan="4" class="empty-state">
                            <i class="fas fa-users"></i>
                            <p>Nenhum cliente encontrado</p>
                            <button class="btn btn-primary btn-sm" onclick="app.syncCustomers()">
                                <i class="fas fa-sync"></i> Sincronizar Clientes
                            </button>
                        </td>
                    </tr>
                `;
                return;
            }

            tbody.innerHTML = this.customers.map(customer => `
                <tr>
                    <td>
                        <strong>${customer.name}</strong>
                        <br><small class="text-muted">ID: ${customer.id}</small>
                    </td>
                    <td>${customer.email || 'N/A'}</td>
                    <td>${customer.phone || 'N/A'}</td>
                    <td>${new Date(customer.last_sync).toLocaleDateString('pt-BR')}</td>
                </tr>
            `).join('');
        } catch (error) {
            console.error('‚ùå Erro ao renderizar clientes:', error);
        }
    }

    // =============================================
    // FUN√á√ïES UTILIT√ÅRIAS
    // =============================================

    async loadReports() {
        try {
            console.log('üìä Carregando dados para relat√≥rios...');
        } catch (error) {
            console.error('‚ùå Erro ao carregar relat√≥rios:', error);
        }
    }

    refreshDashboard() {
        console.log('üîÑ Atualizando dashboard...');
        this.loadDashboardData();
        this.showNotification('Dashboard atualizado', 'success');
    }

    closeModal(modalId) {
        try {
            const modal = document.getElementById(modalId);
            if (modal) {
                modal.remove();
            }
        } catch (error) {
            console.error('‚ùå Erro ao fechar modal:', error);
        }
    }

    closeAllModals() {
        try {
            document.querySelectorAll('.modal-overlay').forEach(modal => {
                modal.remove();
            });
        } catch (error) {
            console.error('‚ùå Erro ao fechar modais:', error);
        }
    }

    showNotification(message, type = 'info') {
        try {
            console.log(`üí¨ Notifica√ß√£o [${type}]: ${message}`);
            
            const notification = document.createElement('div');
            notification.className = `notification ${type} show`;
            notification.innerHTML = `
                <div class="notification-content">
                    <div class="notification-icon">
                        <i class="fas fa-${type === 'success' ? 'check' : type === 'error' ? 'exclamation-triangle' : 'info'}"></i>
                    </div>
                    <div class="notification-message">${message}</div>
                    <button class="notification-close" onclick="this.parentElement.parentElement.remove()">
                        <i class="fas fa-times"></i>
                    </button>
                </div>
            `;

            document.body.appendChild(notification);

            setTimeout(() => {
                if (notification.parentElement) {
                    notification.remove();
                }
            }, 5000);
        } catch (error) {
            console.error('‚ùå Erro ao mostrar notifica√ß√£o:', error);
        }
    }

    showLoading(show, message = 'Carregando...') {
        try {
            const overlay = document.getElementById('loading-overlay');
            const messageElement = document.getElementById('loading-message');
            
            if (overlay && messageElement) {
                if (show) {
                    messageElement.textContent = message;
                    overlay.style.display = 'flex';
                    setTimeout(() => {
                        overlay.style.opacity = '1';
                    }, 10);
                } else {
                    overlay.style.opacity = '0';
                    setTimeout(() => {
                        overlay.style.display = 'none';
                    }, 300);
                }
            }
        } catch (error) {
            console.error('‚ùå Erro ao mostrar loading:', error);
        }
    }

    async debugReloadProducts() {
        console.log('üêõ DEBUG: Recarregando produtos...');
        await this.loadProducts();
        
        console.log('üì¶ Produtos carregados:', this.products);
        
        if (this.products && this.products.length > 0) {
            this.showNotification(`‚úÖ ${this.products.length} produtos carregados`, 'success');
        } else {
            this.showNotification('‚ùå Nenhum produto carregado', 'error');
        }
    }
}

console.log('‚úÖ DOM pronto - Criando EnhancedApp Corrigido...');
document.addEventListener('DOMContentLoaded', function() {
    try {
        window.app = new EnhancedApp();
        console.log('üéØ EnhancedApp Corrigido criado com sucesso!');
    } catch (error) {
        console.error('üí• Erro cr√≠tico na cria√ß√£o do EnhancedApp:', error);
    }
});
''''''''''''''''''''''''
console.log('üåê Iniciando API Corrigida...');

class FirebaseService {
    constructor() {
        this.firestore = null;
        this.auth = null;
        this.storage = null;
        this.isInitialized = false;
        this.isOnline = navigator.onLine;
        
        console.log('üî• Criando FirebaseService Corrigido...');
        this.init();
    }

    async init() {
        try {
            console.log('üîÑ Inicializando Firebase Service...');
            
            if (!window.firebaseConfig) {
                console.log('üîå FirebaseConfig n√£o encontrado - Modo offline ativado');
                this.fallbackToOfflineMode();
                return;
            }

            await this.initializeWithRetry();
            
            if (this.isInitialized) {
                this.setupConnectionMonitoring();
                console.log('‚úÖ Firebase Service inicializado com sucesso');
            }

        } catch (error) {
            console.error('‚ùå Erro na inicializa√ß√£o do Firebase Service:', error);
            this.fallbackToOfflineMode();
        }
    }

    async initializeWithRetry() {
        for (let attempt = 1; attempt <= 3; attempt++) {
            try {
                console.log(`üîÑ Tentativa ${attempt}/3 de conex√£o Firebase...`);
                
                const success = await window.firebaseConfig.initializeFirebase();
                
                if (success) {
                    this.firestore = window.firebaseConfig.getFirestore();
                    this.auth = window.firebaseConfig.getAuth();
                    this.storage = window.firebaseConfig.getStorage();
                    this.isInitialized = true;
                    
                    console.log('‚úÖ Firebase conectado com sucesso');
                    return;
                }
            } catch (error) {
                console.error(`‚ùå Tentativa ${attempt}/3 falhou:`, error.message);
                
                if (attempt === 3) {
                    throw new Error(`Falha ap√≥s 3 tentativas: ${error.message}`);
                }
                
                await new Promise(resolve => setTimeout(resolve, 1000 * attempt));
            }
        }
    }

    setupConnectionMonitoring() {
        window.addEventListener('online', () => {
            this.isOnline = true;
            this.updateConnectionStatus();
            console.log('üåê Conex√£o restaurada');
        });

        window.addEventListener('offline', () => {
            this.isOnline = false;
            this.updateConnectionStatus();
            console.log('üîå Conex√£o perdida - Modo offline');
        });

        this.updateConnectionStatus();
    }

    updateConnectionStatus() {
        const statusElement = document.getElementById('connection-status');
        const statusText = document.getElementById('status-text');
        
        if (statusElement && statusText) {
            if (this.isOnline) {
                statusElement.className = 'status-indicator online';
                statusText.textContent = 'Conectado';
            } else {
                statusElement.className = 'status-indicator offline';
                statusText.textContent = 'Offline';
            }
        }
    }

    fallbackToOfflineMode() {
        console.log('üîå Ativando modo offline...');
        this.isOnline = false;
        this.updateConnectionStatus();
    }
}

class API {
    constructor() {
        this.baseURL = 'http://localhost:3002/api';
        this.token = localStorage.getItem('sales_manager_token');
        this.firebaseService = new FirebaseService();
        
        console.log('‚úÖ API Corrigida criada para Garagem67');
        console.log('üîê Token no localStorage:', this.token ? 'PRESENTE' : 'AUSENTE');
        
        this.testConnection();
    }

    async testConnection() {
        try {
            console.log('üß™ Testando conex√£o com o backend...');
            const response = await fetch(`${this.baseURL}/cors-test`, {
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json',
                }
            });
            
            if (response.ok) {
                const data = await response.json();
                console.log('‚úÖ Teste de conex√£o bem-sucedido:', data.message);
            } else {
                console.warn('‚ö†Ô∏è Teste de conex√£o falhou, servidor pode estar offline');
            }
        } catch (error) {
            console.error('‚ùå Erro no teste de conex√£o:', error.message);
        }
    }

    setToken(token) {
        this.token = token;
        localStorage.setItem('sales_manager_token', token);
        console.log('üîê Token salvo no localStorage:', token.substring(0, 20) + '...');
    }

    removeToken() {
        this.token = null;
        localStorage.removeItem('sales_manager_token');
        console.log('üîê Token removido do localStorage');
    }

    async makeRequest(endpoint, options = {}) {
        const url = `${this.baseURL}${endpoint}`;
        
        const config = {
            mode: 'cors',
            credentials: 'omit',
            headers: {
                'Content-Type': 'application/json',
                'Accept': 'application/json',
            },
            ...options
        };

        if (this.token && this.token !== 'null' && this.token !== 'undefined') {
            config.headers['Authorization'] = `Bearer ${this.token}`;
            console.log('üîê Token inclu√≠do no header Authorization');
        } else {
            console.log('‚ö†Ô∏è Token n√£o inclu√≠do - est√° vazio ou ausente');
        }

        console.log(`üì§ Fazendo requisi√ß√£o para: ${url}`);
        console.log('üîß Configura√ß√£o:', {
            method: config.method,
            headers: Object.keys(config.headers),
            hasToken: !!config.headers['Authorization']
        });

        try {
            const response = await fetch(url, config);
            
            if (!response) {
                throw new Error('N√£o houve resposta do servidor');
            }

            let data;
            try {
                const text = await response.text();
                data = text ? JSON.parse(text) : {};
            } catch (parseError) {
                console.warn('‚ö†Ô∏è Resposta n√£o √© JSON v√°lido, usando fallback');
                data = {
                    success: response.ok,
                    status: response.status,
                    statusText: response.statusText
                };
            }
            
            if (!response.ok) {
                console.error(`‚ùå Erro HTTP ${response.status}:`, data);
                throw new Error(data.error || data.message || `HTTP error! status: ${response.status}`);
            }
            
            console.log(`‚úÖ Resposta recebida de ${endpoint}: SUCESSO`);
            return data;

        } catch (error) {
            console.error(`‚ùå Erro na requisi√ß√£o para ${endpoint}:`, error);
            
            let errorMessage;
            
            if (error.message.includes('Failed to fetch')) {
                errorMessage = 'N√£o foi poss√≠vel conectar ao servidor. Verifique se o backend est√° rodando.';
            } else if (error.message.includes('CORS')) {
                errorMessage = 'Erro de CORS. O servidor n√£o est√° permitindo requisi√ß√µes do frontend.';
            } else if (error.message.includes('Token inv√°lido') || error.message.includes('jwt')) {
                errorMessage = 'Sess√£o expirada. Fa√ßa login novamente.';
                this.removeToken();
            } else {
                errorMessage = error.message;
            }
            
            throw new Error(errorMessage);
        }
    }

    // ‚úÖ M√âTODOS DE PRODUTOS CORRIGIDOS
    async getProducts() {
        const response = await this.makeRequest('/products');
        
        if (response.success) {
            return {
                success: true,
                products: response.data || []
            };
        }
        return response;
    }

    async createProduct(productData) {
        const backendData = {
            name: productData.name,
            price: productData.price,
            category_id: productData.category_id,
            stock_initial: productData.stock_initial || 0
        };
        
        console.log('üì§ Enviando produto para backend:', backendData);
        
        return this.makeRequest('/products', {
            method: 'POST',
            body: JSON.stringify(backendData)
        });
    }

    async updateProduct(productId, productData) {
        return this.makeRequest(`/products/${productId}`, {
            method: 'PUT',
            body: JSON.stringify(productData)
        });
    }

    async getProductById(productId) {
        return this.makeRequest(`/products/${productId}`);
    }

    async deleteProduct(productId) {
        return this.makeRequest(`/products/${productId}`, {
            method: 'DELETE'
        });
    }

    // ‚úÖ M√âTODOS DE VENDAS
    async createSale(saleData) {
        return this.makeRequest('/sales', {
            method: 'POST',
            body: JSON.stringify(saleData)
        });
    }

    async getSales(filters = {}) {
        const params = new URLSearchParams();
        Object.keys(filters).forEach(key => {
            if (filters[key]) params.append(key, filters[key]);
        });
        
        return this.makeRequest(`/sales?${params.toString()}`);
    }

    async getSaleById(saleId) {
        return this.makeRequest(`/sales/${saleId}`);
    }

    async login(username, password) {
        console.log('üîê Iniciando processo de login...');
        const response = await this.makeRequest('/auth/login', {
            method: 'POST',
            body: JSON.stringify({ username, password })
        });

        if (response.success && response.token) {
            this.setToken(response.token);
            console.log('‚úÖ Login bem-sucedido, token armazenado');
        } else {
            console.error('‚ùå Login falhou:', response.error);
        }

        return response;
    }

    async verifyToken() {
        return this.makeRequest('/auth/verify');
    }

    async getDashboardStats() {
        return this.makeRequest('/dashboard/stats');
    }

    async getDashboardMetrics() {
        return this.makeRequest('/dashboard/metrics');
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o syncCustomers REAL
    async syncCustomers() {
        try {
            console.log('üîÑ API: Iniciando sincroniza√ß√£o REAL...');
            
            // ‚úÖ CORRE√á√ÉO: Fazer requisi√ß√£o REAL para o backend
            const response = await this.makeRequest('/sync/customers/full-sync', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                }
            });

            console.log('üì° Resposta da sincroniza√ß√£o:', response);

            if (response && response.success) {
                return {
                    success: true,
                    message: response.message || 'Sincroniza√ß√£o realizada com sucesso!',
                    data: response.data
                };
            } else {
                // ‚úÖ CORRE√á√ÉO: Mensagem de erro mais clara
                throw new Error(response?.error || 'Falha na comunica√ß√£o com o servidor');
            }
            
        } catch (error) {
            console.error('‚ùå API: Erro na sincroniza√ß√£o REAL:', error);
            
            // ‚úÖ CORRE√á√ÉO: Fallback mais inteligente
            if (error.message.includes('Failed to fetch') || error.message.includes('CORS')) {
                return await this.syncCustomersFallback();
            }
            
            return {
                success: false,
                error: error.message
            };
        }
    }

    // ‚úÖ CORRE√á√ÉO: Fun√ß√£o de fallback
    async syncCustomersFallback() {
        try {
            console.log('üîÑ API: Usando fallback de sincroniza√ß√£o...');
            await new Promise(resolve => setTimeout(resolve, 2000));
            
            return {
                success: true,
                message: '‚úÖ 3 clientes de exemplo sincronizados! (Modo Desenvolvimento)',
                data: {
                    statistics: {
                        created: 3,
                        updated: 0,
                        errors: 0,
                        skipped: 0,
                        synced: 3,
                        total_found: 3
                    },
                    timestamp: new Date().toISOString()
                }
            };
        } catch (error) {
            return {
                success: false,
                error: error.message
            };
        }
    }

    async getInventory() {
        return this.makeRequest('/inventory');
    }

    async generateReport(filters = {}) {
        const params = new URLSearchParams(filters);
        return this.makeRequest(`/export/sales-report?${params.toString()}`);
    }
}

console.log('üåê Criando inst√¢ncia global da API Corrigida...');
window.api = new API();
console.log('üéØ API Corrigida pronta para uso');
'''''''''''''''''''''''''''''
backend:
const express = require('express');
const cors = require('cors');
const helmet = require('helmet');
const compression = require('compression');
const rateLimit = require('express-rate-limit');
const path = require('path');
require('dotenv').config();

// ‚úÖ CORRE√á√ÉO: Importar servi√ßos CORRETAMENTE
const SyncService = require('./services/syncService');
const syncService = new SyncService(); // ‚≠ê √öNICA INST√ÇNCIA

// ‚úÖ CORRE√á√ÉO: Importar logger corretamente
const Logger = require('./middleware/logger');

const app = express();
const PORT = process.env.PORT || 3002;
const HOST = process.env.HOST || '0.0.0.0';

// ‚úÖ‚úÖ‚úÖ CONFIGURA√á√ÉO CORS SIMPLIFICADA E FUNCIONAL
const corsOptions = {
  origin: ['http://localhost:5500', 'http://127.0.0.1:5500', 'http://localhost:3000', 'http://127.0.0.1:3000'],
  credentials: false,
  methods: ['GET', 'POST', 'PUT', 'DELETE', 'PATCH', 'OPTIONS'],
  allowedHeaders: ['Content-Type', 'Authorization', 'Accept'],
  optionsSuccessStatus: 200
};

// ‚úÖ APLICAR CORS PRIMEIRO
app.use(cors(corsOptions));

// ‚úÖ MIDDLEWARE CORS MANUAL COMO BACKUP
app.use((req, res, next) => {
  const allowedOrigins = ['http://localhost:5500', 'http://127.0.0.1:5500'];
  const origin = req.headers.origin;
  
  if (allowedOrigins.includes(origin)) {
    res.header('Access-Control-Allow-Origin', origin);
  }
  
  res.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  res.header('Access-Control-Allow-Headers', 'Content-Type, Authorization, Accept');
  res.header('Access-Control-Allow-Credentials', 'false');
  
  if (req.method === 'OPTIONS') {
    return res.status(200).end();
  }
  
  next();
});

// Middleware de seguran√ßa
app.use(helmet({
  crossOriginResourcePolicy: { policy: "cross-origin" },
  contentSecurityPolicy: false
}));

app.use(compression());

// Rate limiting
const limiter = rateLimit({
  windowMs: 15 * 60 * 1000,
  max: 1000,
  message: { error: 'Muitas requisi√ß√µes' }
});
app.use(limiter);

app.use(express.json({ limit: '10mb' }));
app.use(express.urlencoded({ extended: true, limit: '10mb' }));

// ‚úÖ CORRE√á√ÉO: Middleware de logging simplificado
app.use((req, res, next) => {
  console.log(`üì• ${req.method} ${req.path} - ${new Date().toISOString()}`);
  next();
});

// Servir arquivos est√°ticos
app.use(express.static(path.join(__dirname, 'public')));

// Conectar ao banco de dados
const db = require('./config/database');

// ‚úÖ ROTA DE TESTE CORS - SIMPLIFICADA
app.get('/api/cors-test', (req, res) => {
  res.json({
    success: true,
    message: '‚úÖ CORS est√° funcionando!',
    timestamp: new Date().toISOString(),
    origin: req.headers.origin
  });
});

// ‚úÖ CORRE√á√ÉO: Importar e usar rotas CORRETAMENTE
app.use('/api/auth', require('./routes/auth'));
app.use('/api/sales', require('./routes/sales'));
app.use('/api/products', require('./routes/products'));
app.use('/api/customers', require('./routes/customers'));
app.use('/api/export', require('./routes/export'));
app.use('/api/inventory', require('./routes/inventory'));
app.use('/api/dashboard', require('./routes/dashboard'));

// ‚úÖ CORRE√á√ÉO: Rotas de sync com inst√¢ncia correta
const syncRoutes = require('./routes/sync');
app.use('/api/sync', syncRoutes);

// Rota de sa√∫de
app.get('/api/health', (req, res) => {
  res.json({
    status: 'OK',
    timestamp: new Date().toISOString(),
    service: 'Sales Manager Backend',
    version: '2.1.0',
    database: 'SQLite',
    environment: process.env.NODE_ENV || 'development'
  });
});

// Rota raiz
app.get('/', (req, res) => {
  res.json({
    message: 'üöÄ Sales Manager API - Garagem 67',
    version: '2.1.0',
    status: 'Operacional',
    endpoints: {
      health: '/api/health',
      cors_test: '/api/cors-test',
      auth: '/api/auth'
    }
  });
});

// Middleware para rotas n√£o encontradas
app.use('*', (req, res) => {
  res.status(404).json({
    success: false,
    error: 'Rota n√£o encontrada',
    path: req.originalUrl
  });
});

// Error handling
app.use((error, req, res, next) => {
  console.error('‚ùå Erro no servidor:', error);
  res.status(500).json({
    success: false,
    error: 'Erro interno do servidor',
    message: process.env.NODE_ENV === 'production' ? 'Erro interno' : error.message
  });
});

// ‚úÖ CORRE√á√ÉO: Inicializa√ß√£o mais segura
setTimeout(() => {
  if (process.env.AUTO_SYNC !== 'false') {
    syncService.startAutoSync();
    console.log('üîÑ Sincroniza√ß√£o autom√°tica ativada');
  }
}, 5000);

// Inicializar servidor
const server = app.listen(PORT, HOST, () => {
  console.log('='.repeat(60));
  console.log(`üõçÔ∏è  SALES MANAGER - GARAGEM 67`);
  console.log('='.repeat(60));
  console.log(`üìç Servidor: http://localhost:${PORT}`);
  console.log(`üåê Acesso: http://${HOST}:${PORT}`);
  console.log(`‚ù§Ô∏è  Health: http://localhost:${PORT}/api/health`);
  console.log(`üß™ CORS Test: http://localhost:${PORT}/api/cors-test`);
  console.log(`üîó Ambiente: ${process.env.NODE_ENV || 'development'}`);
  console.log('='.repeat(60));
});

// Graceful shutdown
process.on('SIGTERM', () => {
  console.log('üîª Encerrando servidor...');
  server.close(() => {
    process.exit(0);
  });
});

process.on('SIGINT', () => {
  console.log('üîª Encerrando servidor...');
  server.close(() => {
    process.exit(0);
  });
});

module.exports = { app, server };
'''''''''''''''''''''''''''''''
{
  "name": "sales-manager-backend",
  "version": "2.1.1",
  "description": "Backend do Sales Manager - Garagem 67 - CORS CORRIGIDO",
  "main": "server.js",
  "scripts": {
    "start": "node server.js",
    "dev": "nodemon server.js",
    "fix-cors": "node -e \"console.log('‚úÖ CORS configurado no servidor')\""
  },
  "dependencies": {
    "bcryptjs": "^2.4.3",
    "better-sqlite3": "^8.4.0",
    "compression": "^1.7.4",
    "cors": "^2.8.5",
    "dotenv": "^16.3.1",
    "express": "^4.18.2",
    "express-rate-limit": "^6.8.1",
    "firebase-admin": "^11.8.0",
    "helmet": "^7.0.0",
    "jsonwebtoken": "^9.0.1",
    "winston": "^3.18.3"
  },
  "devDependencies": {
    "nodemon": "^2.0.22"
  },
  "keywords": [
    "sales",
    "manager",
    "garagem67",
    "backend",
    "cors-fixed"
  ],
  "author": "Garagem 67 Team",
  "license": "MIT"
}
'''''''''''''''''''''''''''''''''
// ‚úÖ CORRE√á√ÉO: Vers√£o simplificada e funcional do SyncService
const db = require('../config/database');

class SyncService {
    constructor() {
        this.isInitialized = false;
        this.syncInProgress = false;
        this.autoSyncInterval = null;
        console.log('‚úÖ SyncService inicializado');
    }

    // üÜï M√âTODO: Iniciar sincroniza√ß√£o autom√°tica
    startAutoSync(intervalMinutes = 60) {
        if (this.autoSyncInterval) {
            clearInterval(this.autoSyncInterval);
        }
        
        console.log(`üîÑ Sincroniza√ß√£o autom√°tica configurada para ${intervalMinutes} minutos`);
        
        this.autoSyncInterval = setInterval(async () => {
            try {
                if (!this.syncInProgress) {
                    console.log('üîÑ Executando sincroniza√ß√£o autom√°tica...');
                    await this.syncCustomersReal();
                }
            } catch (error) {
                console.error('‚ùå Erro na sincroniza√ß√£o autom√°tica:', error);
            }
        }, intervalMinutes * 60 * 1000);
    }

    // üÜï M√âTODO: Parar sincroniza√ß√£o autom√°tica
    stopAutoSync() {
        if (this.autoSyncInterval) {
            clearInterval(this.autoSyncInterval);
            this.autoSyncInterval = null;
            console.log('üîï Sincroniza√ß√£o autom√°tica parada');
        }
    }

    // üîÑ Sincroniza√ß√£o REAL com Garagem67
    async syncCustomersReal() {
        if (this.syncInProgress) {
            throw new Error('Sincroniza√ß√£o j√° em andamento');
        }

        this.syncInProgress = true;

        try {
            console.log('üîÑ Iniciando sincroniza√ß√£o REAL com Garagem67...');
            
            // ‚úÖ CORRE√á√ÉO: Usar dados de exemplo (Firebase pode n√£o estar configurado)
            const firebaseCustomers = this.getMockCustomers();
            
            console.log(`üì• ${firebaseCustomers.length} clientes encontrados para sincroniza√ß√£o`);

            let created = 0;
            let updated = 0;
            let errors = 0;

            // Processar cada cliente
            for (const customerData of firebaseCustomers) {
                try {
                    const existingStmt = db.prepare('SELECT id FROM customers WHERE firebase_id = ? OR email = ?');
                    const existing = existingStmt.get(customerData.firebase_id, customerData.email);

                    const now = new Date().toISOString();

                    if (existing) {
                        // Atualizar cliente existente
                        const updateStmt = db.prepare(`
                            UPDATE customers SET 
                            name = ?, email = ?, phone = ?, cpf = ?, address = ?, 
                            city = ?, state = ?, cep = ?, complemento = ?, last_sync = ?
                            WHERE id = ?
                        `);
                        
                        const result = updateStmt.run(
                            customerData.name,
                            customerData.email,
                            customerData.phone,
                            customerData.cpf,
                            customerData.address,
                            customerData.city,
                            customerData.state,
                            customerData.cep,
                            customerData.complemento,
                            now,
                            existing.id
                        );
                        
                        if (result.changes > 0) updated++;
                    } else {
                        // Inserir novo cliente
                        const insertStmt = db.prepare(`
                            INSERT INTO customers 
                            (firebase_id, name, email, phone, cpf, address, city, state, cep, complemento, last_sync, created_at) 
                            VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
                        `);
                        
                        const result = insertStmt.run(
                            customerData.firebase_id,
                            customerData.name,
                            customerData.email,
                            customerData.phone,
                            customerData.cpf,
                            customerData.address,
                            customerData.city,
                            customerData.state,
                            customerData.cep,
                            customerData.complemento,
                            now,
                            now
                        );
                        
                        if (result.changes > 0) created++;
                    }
                } catch (error) {
                    console.error(`‚ùå Erro ao processar cliente ${customerData.firebase_id}:`, error);
                    errors++;
                }
            }

            // Salvar estat√≠sticas
            await this.updateSyncStatistics(`real_sync_${Date.now()}`, {
                created,
                updated,
                errors,
                skipped: 0,
                synced: created + updated
            }, 'garagem67_real_sync');

            const resultMessage = `‚úÖ Sincroniza√ß√£o REAL: ${created} novos, ${updated} atualizados, ${errors} erros`;
            console.log(resultMessage);
            
            return {
                success: true,
                message: resultMessage,
                statistics: {
                    created,
                    updated,
                    errors,
                    skipped: 0,
                    synced: created + updated,
                    total_found: firebaseCustomers.length
                },
                timestamp: new Date().toISOString(),
                source: 'garagem67_firebase'
            };

        } catch (error) {
            console.error('‚ùå Erro na sincroniza√ß√£o REAL:', error);
            throw error;
        } finally {
            this.syncInProgress = false;
        }
    }

    // üìã Dados de exemplo para desenvolvimento
    getMockCustomers() {
        return [
            {
                firebase_id: 'garagem67_cust_001',
                name: 'Jo√£o Silva - Garagem67',
                email: 'joao@garagem67.com',
                phone: '(67) 99999-9999',
                cpf: '123.456.789-00',
                address: 'Rua Principal, 123',
                city: 'Ivinhema',
                state: 'MS',
                cep: '79760-000',
                complemento: 'Centro',
                is_active: true
            },
            {
                firebase_id: 'garagem67_cust_002',
                name: 'Maria Santos - Garagem67',
                email: 'maria@garagem67.com',
                phone: '(67) 98888-8888',
                cpf: '987.654.321-00',
                address: 'Av. Central, 456',
                city: 'Ivinhema', 
                state: 'MS',
                cep: '79760-000',
                complemento: 'Pr√≥ximo ao mercado',
                is_active: true
            },
            {
                firebase_id: 'garagem67_cust_003',
                name: 'Pedro Oliveira - Garagem67',
                email: 'pedro@garagem67.com',
                phone: '(67) 97777-7777',
                cpf: '456.789.123-00',
                address: 'Rua das Flores, 789',
                city: 'Ivinhema',
                state: 'MS',
                cep: '79760-000',
                complemento: '',
                is_active: true
            }
        ];
    }

    // üîÑ Sincroniza√ß√£o b√°sica - vers√£o simplificada (para compatibilidade)
    async syncCustomersFromGaragem67() {
        return await this.syncCustomersReal();
    }

    // üìä Atualizar estat√≠sticas de sincroniza√ß√£o
    async updateSyncStatistics(sessionId, results, syncType = 'garagem67_sync') {
        try {
            const stmt = db.prepare(`
                INSERT INTO sync_logs 
                (session_id, sync_type, items_created, items_updated, items_skipped, error_count, total_synced) 
                VALUES (?, ?, ?, ?, ?, ?, ?)
            `);

            stmt.run(
                sessionId,
                syncType,
                results.created,
                results.updated,
                results.skipped,
                results.errors,
                results.synced
            );
        } catch (error) {
            console.error('‚ùå Erro ao salvar estat√≠sticas:', error);
        }
    }

    // üîç Verificar status da sincroniza√ß√£o
    getSyncStatus() {
        return {
            isInitialized: this.isInitialized,
            syncInProgress: this.syncInProgress,
            lastSync: this.getLastSyncDate(),
            autoSync: !!this.autoSyncInterval
        };
    }

    // üìÖ Buscar √∫ltima sincroniza√ß√£o
    getLastSyncDate() {
        try {
            const stmt = db.prepare(`
                SELECT sync_date FROM sync_logs 
                ORDER BY sync_date DESC 
                LIMIT 1
            `);
            const result = stmt.get();
            return result ? result.sync_date : null;
        } catch (error) {
            return null;
        }
    }

    // ‚ö° Sincroniza√ß√£o r√°pida
    async quickSyncGaragem67() {
        try {
            const result = await this.syncCustomersReal();
            return {
                success: true,
                message: 'Sincroniza√ß√£o r√°pida conclu√≠da',
                data: result
            };
        } catch (error) {
            throw error;
        }
    }

    // üìÑ Gerar JSON para Entregador67
    async generateEntregador67Json() {
        try {
            const stmt = db.prepare(`
                SELECT id, name, email, phone, city, state 
                FROM customers 
                WHERE is_active = 1
                ORDER BY name
            `);
            
            const customers = stmt.all();
            
            const entregador67Data = {
                export_type: "customers_export",
                version: "1.0",
                exported_at: new Date().toISOString(),
                store: {
                    name: "Garagem 67",
                    system: "Sales Manager"
                },
                customers: customers
            };

            return entregador67Data;

        } catch (error) {
            console.error('‚ùå Erro ao gerar JSON:', error);
            throw error;
        }
    }
}

// ‚úÖ CORRE√á√ÉO: Exportar a classe corretamente
module.exports = SyncService;
''''''''''''''''''''''
const { getFirebaseAdmin, isFirebaseAvailable } = require('../config/firebase');
const db = require('../config/database');

class FirebaseService {
  // Verificar se o Firebase est√° dispon√≠vel
  static isFirebaseAvailable() {
    return isFirebaseAvailable();
  }

  // Sincronizar clientes do Firebase
  static async syncCustomers() {
    try {
      const admin = getFirebaseAdmin();
      
      // Verificar se o Firebase est√° dispon√≠vel
      if (!this.isFirebaseAvailable() || !admin) {
        console.log('üîß Modo desenvolvimento: Simulando sincroniza√ß√£o de clientes');
        
        // Gerar alguns clientes de exemplo para desenvolvimento
        const mockCustomers = [
          {
            firebase_uid: 'user_001',
            name: 'Jo√£o Silva',
            email: 'joao@email.com',
            phone: '(67) 99999-9999'
          },
          {
            firebase_uid: 'user_002', 
            name: 'Maria Santos',
            email: 'maria@email.com',
            phone: '(67) 98888-8888'
          },
          {
            firebase_uid: 'user_003',
            name: 'Pedro Oliveira',
            email: 'pedro@email.com',
            phone: '(67) 97777-7777'
          },
          {
            firebase_uid: 'user_004',
            name: 'Ana Costa',
            email: 'ana@email.com',
            phone: '(67) 96666-6666'
          },
          {
            firebase_uid: 'user_005',
            name: 'Carlos Souza',
            email: 'carlos@email.com',
            phone: '(67) 95555-5555'
          }
        ];

        let syncedCount = 0;
        let errorCount = 0;

        for (const customerData of mockCustomers) {
          try {
            // Verificar se cliente j√° existe (usando better-sqlite3 corretamente)
            const selectStmt = db.prepare('SELECT id FROM customers WHERE firebase_uid = ?');
            const existingCustomer = selectStmt.get(customerData.firebase_uid);

            const now = new Date().toISOString();

            if (existingCustomer) {
              // Tentar atualizar cliente existente
              try {
                const updateStmt = db.prepare(`
                  UPDATE customers SET 
                  name = ?, email = ?, phone = ?, last_sync = ?, updated_at = ?
                  WHERE firebase_uid = ?
                `);
                updateStmt.run(
                  customerData.name,
                  customerData.email,
                  customerData.phone,
                  now,
                  now,
                  customerData.firebase_uid
                );
                syncedCount++;
                console.log(`‚úÖ Cliente atualizado: ${customerData.name}`);
              } catch (updateError) {
                // Se falhar, tentar sem updated_at
                console.log('üîÑ Tentando atualizar sem updated_at...');
                const updateStmt = db.prepare(`
                  UPDATE customers SET 
                  name = ?, email = ?, phone = ?, last_sync = ?
                  WHERE firebase_uid = ?
                `);
                updateStmt.run(
                  customerData.name,
                  customerData.email,
                  customerData.phone,
                  now,
                  customerData.firebase_uid
                );
                syncedCount++;
                console.log(`‚úÖ Cliente atualizado (sem updated_at): ${customerData.name}`);
              }
            } else {
              // Tentar inserir novo cliente
              try {
                const insertStmt = db.prepare(`
                  INSERT INTO customers (firebase_uid, name, email, phone, last_sync, created_at, updated_at) 
                  VALUES (?, ?, ?, ?, ?, ?, ?)
                `);
                insertStmt.run(
                  customerData.firebase_uid,
                  customerData.name,
                  customerData.email,
                  customerData.phone,
                  now,
                  now,
                  now
                );
                syncedCount++;
                console.log(`‚úÖ Cliente criado: ${customerData.name}`);
              } catch (insertError) {
                // Se falhar, tentar sem updated_at
                console.log('üîÑ Tentando inserir sem updated_at...');
                const insertStmt = db.prepare(`
                  INSERT INTO customers (firebase_uid, name, email, phone, last_sync, created_at) 
                  VALUES (?, ?, ?, ?, ?, ?)
                `);
                insertStmt.run(
                  customerData.firebase_uid,
                  customerData.name,
                  customerData.email,
                  customerData.phone,
                  now,
                  now
                );
                syncedCount++;
                console.log(`‚úÖ Cliente criado (sem updated_at): ${customerData.name}`);
              }
            }
          } catch (error) {
            console.error(`‚ùå Erro ao sincronizar cliente ${customerData.firebase_uid}:`, error.message);
            errorCount++;
          }
        }

        console.log(`‚úÖ Sincroniza√ß√£o simulada: ${syncedCount} clientes processados, ${errorCount} erros`);
        return {
          success: true,
          synced: syncedCount,
          errors: errorCount,
          total: mockCustomers.length,
          mode: 'development'
        };
      }

      console.log('üîÑ Sincronizando clientes do Firebase...');
      
      // Buscar usu√°rios do Firebase Auth (produ√ß√£o)
      const listUsersResult = await admin.auth().listUsers(1000);
      const firebaseUsers = listUsersResult.users;
      
      let syncedCount = 0;
      let errorCount = 0;

      for (const user of firebaseUsers) {
        try {
          // Verificar se cliente j√° existe
          const selectStmt = db.prepare('SELECT id FROM customers WHERE firebase_uid = ?');
          const existingCustomer = selectStmt.get(user.uid);

          const customerData = {
            firebase_uid: user.uid,
            name: user.displayName || (user.email ? user.email.split('@')[0] : 'Usu√°rio sem nome'),
            email: user.email || null,
            phone: user.phoneNumber || null,
            last_sync: new Date().toISOString()
          };

          const now = new Date().toISOString();

          if (existingCustomer) {
            // Atualizar cliente existente
            const updateStmt = db.prepare(`
              UPDATE customers SET 
              name = ?, email = ?, phone = ?, last_sync = ?, updated_at = ?
              WHERE firebase_uid = ?
            `);
            updateStmt.run(
              customerData.name,
              customerData.email,
              customerData.phone,
              customerData.last_sync,
              now,
              customerData.firebase_uid
            );
          } else {
            // Inserir novo cliente
            const insertStmt = db.prepare(`
              INSERT INTO customers (firebase_uid, name, email, phone, last_sync, created_at, updated_at) 
              VALUES (?, ?, ?, ?, ?, ?, ?)
            `);
            insertStmt.run(
              customerData.firebase_uid,
              customerData.name,
              customerData.email,
              customerData.phone,
              customerData.last_sync,
              now,
              now
            );
          }

          syncedCount++;
          console.log(`‚úÖ Cliente sincronizado: ${customerData.name}`);
        } catch (error) {
          console.error(`‚ùå Erro ao sincronizar usu√°rio ${user.uid}:`, error.message);
          errorCount++;
        }
      }

      console.log(`‚úÖ Sincroniza√ß√£o conclu√≠da: ${syncedCount} clientes sincronizados, ${errorCount} erros`);
      return {
        success: true,
        synced: syncedCount,
        errors: errorCount,
        total: firebaseUsers.length,
        mode: 'production'
      };

    } catch (error) {
      console.error('‚ùå Erro na sincroniza√ß√£o de clientes:', error);
      return {
        success: false,
        error: error.message
      };
    }
  }

  // Buscar cliente por UID do Firebase
  static async getCustomerByUid(firebaseUid) {
    try {
      const stmt = db.prepare('SELECT * FROM customers WHERE firebase_uid = ?');
      return stmt.get(firebaseUid);
    } catch (error) {
      console.error('‚ùå Erro ao buscar cliente:', error);
      throw error;
    }
  }

  // Buscar todos os clientes
  static async getCustomers(search = '', page = 1, limit = 50) {
    try {
      let whereConditions = ['1=1'];
      let params = [];

      if (search) {
        whereConditions.push('(name LIKE ? OR email LIKE ? OR phone LIKE ?)');
        const searchTerm = `%${search}%`;
        params.push(searchTerm, searchTerm, searchTerm);
      }

      const offset = (page - 1) * limit;
      const whereClause = whereConditions.join(' AND ');

      // Buscar clientes
      const customersStmt = db.prepare(`
        SELECT * FROM customers 
        WHERE ${whereClause}
        ORDER BY name
        LIMIT ? OFFSET ?
      `);
      const customers = customersStmt.all(...params, limit, offset);

      // Contar total
      const countStmt = db.prepare(`SELECT COUNT(*) as total FROM customers WHERE ${whereClause}`);
      const countResult = countStmt.get(...params);

      return {
        customers,
        pagination: {
          page: parseInt(page),
          limit: parseInt(limit),
          total: countResult.total,
          pages: Math.ceil(countResult.total / limit)
        }
      };
    } catch (error) {
      console.error('‚ùå Erro ao buscar clientes:', error);
      throw error;
    }
  }
}

module.exports = FirebaseService;
''''''''''''''''''''''''''''''''''
const express = require('express');
const router = express.Router();
const SyncService = require('../services/syncService');

// ‚úÖ CORRE√á√ÉO: Instanciar o SyncService uma √∫nica vez
const syncService = new SyncService();

// Rota de sincroniza√ß√£o de clientes
router.post('/customers/full-sync', async (req, res) => {
  try {
    console.log('üîÑ Iniciando sincroniza√ß√£o completa de clientes...');
    
    const result = await syncService.syncCustomersReal();
    
    res.json({
      success: true,
      message: 'Sincroniza√ß√£o conclu√≠da com sucesso',
      data: result
    });
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Rota de sincroniza√ß√£o r√°pida
router.post('/customers/quick-sync', async (req, res) => {
  try {
    console.log('‚ö° Iniciando sincroniza√ß√£o r√°pida...');
    
    const result = await syncService.quickSyncGaragem67();
    
    res.json({
      success: true,
      message: 'Sincroniza√ß√£o r√°pida conclu√≠da',
      data: result
    });
  } catch (error) {
    console.error('‚ùå Erro na sincroniza√ß√£o r√°pida:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Rota de status da sincroniza√ß√£o
router.get('/status', (req, res) => {
  try {
    const status = syncService.getSyncStatus();
    
    res.json({
      success: true,
      data: status
    });
  } catch (error) {
    console.error('‚ùå Erro ao buscar status:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Rota para gerar JSON do Entregador67
router.get('/generate-json', async (req, res) => {
  try {
    console.log('üìÑ Gerando JSON para Entregador67...');
    
    const jsonData = await syncService.generateEntregador67Json();
    
    res.setHeader('Content-Type', 'application/json');
    res.setHeader('Content-Disposition', 'attachment; filename=entregador67_customers.json');
    
    res.json(jsonData);
  } catch (error) {
    console.error('‚ùå Erro ao gerar JSON:', error);
    res.status(500).json({
      success: false,
      error: error.message
    });
  }
});

// Rota de teste
router.get('/test', (req, res) => {
  res.json({
    success: true,
    message: 'Rota de sync funcionando!',
    service: 'Sync Service',
    status: syncService.getSyncStatus()
  });
});

module.exports = router;
''''''''''''''''''''''''
const express = require('express');
const bcrypt = require('bcryptjs');
const jwt = require('jsonwebtoken');
const db = require('../config/database');
const authMiddleware = require('../middleware/auth');

const router = express.Router();
const JWT_SECRET = process.env.JWT_SECRET || 'sales_manager_jwt_secret_2025';

// ‚úÖ ROTA DE LOGIN COMPLETAMENTE CORRIGIDA
router.post('/login', async (req, res) => {
  try {
    const { username, password } = req.body;

    console.log('üîê Tentativa de login recebida:', { username });

    if (!username || !password) {
      console.log('‚ùå Credenciais incompletas');
      return res.status(400).json({
        success: false,
        error: 'Username e password s√£o obrigat√≥rios'
      });
    }

    // ‚úÖ LOGIN DE DESENVOLVIMENTO - SEMPRE FUNCIONA
    if (username === 'admin' && password === 'admin123') {
      console.log('‚úÖ Credenciais de desenvolvimento aceitas');

      const userPayload = {
        userId: 1,
        username: 'admin',
        role: 'admin',
        email: 'admin@garagem67.com'
      };

      // ‚úÖ CORRE√á√ÉO: Gerar token com payload consistente
      const token = jwt.sign(userPayload, JWT_SECRET, { 
        expiresIn: '24h',
        issuer: 'sales-manager-backend',
        subject: 'admin'
      });

      console.log('‚úÖ Token JWT gerado com sucesso');
      console.log('üîê Payload do token:', userPayload);

      return res.json({
        success: true,
        token: token,
        user: {
          id: 1,
          username: 'admin',
          email: 'admin@garagem67.com',
          role: 'admin',
          full_name: 'Administrador - Garagem 67'
        },
        message: 'Login realizado com sucesso'
      });
    }

    // ‚úÖ FALLBACK: Buscar usu√°rio no banco de dados
    console.log('üîê Buscando usu√°rio no banco:', username);
    
    db.get(
      'SELECT * FROM users WHERE username = ? AND is_active = 1',
      [username],
      async (err, user) => {
        if (err) {
          console.error('‚ùå Erro no banco:', err);
          return res.status(500).json({
            success: false,
            error: 'Erro interno do servidor'
          });
        }

        if (!user) {
          console.log('‚ùå Usu√°rio n√£o encontrado:', username);
          return res.status(401).json({
            success: false,
            error: 'Credenciais inv√°lidas'
          });
        }

        console.log('‚úÖ Usu√°rio encontrado:', user.username);

        // Verificar senha
        const isValidPassword = await bcrypt.compare(password, user.password_hash);
        if (!isValidPassword) {
          console.log('‚ùå Senha incorreta para:', username);
          return res.status(401).json({
            success: false,
            error: 'Credenciais inv√°lidas'
          });
        }

        // Gerar token JWT
        const tokenPayload = {
          userId: user.id,
          username: user.username,
          role: user.role,
          email: user.email
        };

        const token = jwt.sign(tokenPayload, JWT_SECRET, { 
          expiresIn: '24h',
          issuer: 'sales-manager-backend',
          subject: user.username
        });

        console.log('‚úÖ Login bem-sucedido via banco:', user.username);

        res.json({
          success: true,
          token: token,
          user: {
            id: user.id,
            username: user.username,
            email: user.email,
            role: user.role,
            full_name: user.full_name
          }
        });
      }
    );
  } catch (error) {
    console.error('‚ùå Erro cr√≠tico no login:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
});

// ‚úÖ ROTA DE VERIFICA√á√ÉO CORRIGIDA
router.get('/verify', authMiddleware, (req, res) => {
  try {
    console.log('‚úÖ Token verificado com sucesso para:', req.user.username);
    
    res.json({
      success: true,
      user: req.user,
      message: 'Token v√°lido'
    });
  } catch (error) {
    console.error('‚ùå Erro na verifica√ß√£o:', error);
    res.status(401).json({
      success: false,
      error: 'Token inv√°lido'
    });
  }
});

// ‚úÖ ROTA DE LOGOUT
router.post('/logout', authMiddleware, (req, res) => {
  console.log('üîê Logout solicitado por:', req.user.username);
  
  res.json({
    success: true,
    message: 'Logout realizado com sucesso'
  });
});

// Alterar senha
router.post('/change-password', authMiddleware, async (req, res) => {
  try {
    const { currentPassword, newPassword } = req.body;

    if (!currentPassword || !newPassword) {
      return res.status(400).json({
        success: false,
        error: 'Senha atual e nova senha s√£o obrigat√≥rias'
      });
    }

    console.log('üîê Altera√ß√£o de senha solicitada por:', req.user.username);

    // Buscar usu√°rio
    db.get(
      'SELECT * FROM users WHERE id = ?',
      [req.user.userId],
      async (err, user) => {
        if (err || !user) {
          return res.status(404).json({
            success: false,
            error: 'Usu√°rio n√£o encontrado'
          });
        }

        // Verificar senha atual
        const isValidPassword = await bcrypt.compare(currentPassword, user.password_hash);
        if (!isValidPassword) {
          return res.status(401).json({
            success: false,
            error: 'Senha atual incorreta'
          });
        }

        // Hash da nova senha
        const newPasswordHash = await bcrypt.hash(newPassword, 10);

        // Atualizar senha
        db.run(
          'UPDATE users SET password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?',
          [newPasswordHash, user.id],
          function(err) {
            if (err) {
              console.error('‚ùå Erro ao atualizar senha:', err);
              return res.status(500).json({
                success: false,
                error: 'Erro ao atualizar senha'
              });
            }

            console.log('‚úÖ Senha alterada com sucesso para:', user.username);

            res.json({
              success: true,
              message: 'Senha alterada com sucesso'
            });
          }
        );  
      }
    );
  } catch (error) {
    console.error('‚ùå Erro ao alterar senha:', error);
    res.status(500).json({
      success: false,
      error: 'Erro interno do servidor'
    });
  }
});

module.exports = router;
'''''''''''''''''''''''''''''''
const jwt = require('jsonwebtoken');

const JWT_SECRET = process.env.JWT_SECRET || 'sales_manager_jwt_secret_2025';

// ‚úÖ MIDDLEWARE DE AUTENTICA√á√ÉO COMPLETAMENTE CORRIGIDO
const authMiddleware = (req, res, next) => {
  try {
    console.log('üîê Iniciando verifica√ß√£o de autentica√ß√£o...');
    console.log('üì® Headers recebidos:', {
      authorization: req.headers.authorization ? 'PRESENTE' : 'AUSENTE',
      origin: req.headers.origin,
      'user-agent': req.headers['user-agent']
    });

    const authHeader = req.headers.authorization;
    
    if (!authHeader) {
      console.log('‚ùå Token n√£o fornecido - Header Authorization ausente');
      return res.status(401).json({
        success: false,
        error: 'Token de autentica√ß√£o n√£o fornecido',
        details: 'Header Authorization est√° ausente'
      });
    }

    // ‚úÖ CORRE√á√ÉO: Suportar tanto "Bearer token" quanto apenas o token
    let token;
    if (authHeader.startsWith('Bearer ')) {
      token = authHeader.substring(7);
    } else {
      token = authHeader;
    }
    
    if (!token || token === 'null' || token === 'undefined') {
      console.log('‚ùå Token inv√°lido ou vazio:', token);
      return res.status(401).json({
        success: false,
        error: 'Token inv√°lido',
        details: 'Token est√° vazio ou mal formatado'
      });
    }

    console.log('üîê Token recebido (primeiros 20 chars):', token.substring(0, 20) + '...');

    // ‚úÖ CORRE√á√ÉO: Verificar token com mais detalhes
    try {
      const decoded = jwt.verify(token, JWT_SECRET);
      console.log('‚úÖ Token v√°lido para:', decoded.username, '- UserID:', decoded.userId);
      
      // Adicionar usu√°rio √† requisi√ß√£o
      req.user = decoded;
      
      next();
    } catch (jwtError) {
      console.error('‚ùå Erro na verifica√ß√£o JWT:', jwtError.message);
      
      if (jwtError.name === 'TokenExpiredError') {
        return res.status(401).json({
          success: false,
          error: 'Token expirado',
          details: 'Fa√ßa login novamente'
        });
      }
      
      if (jwtError.name === 'JsonWebTokenError') {
        return res.status(401).json({
          success: false,
          error: 'Token inv√°lido',
          details: jwtError.message
        });
      }

      throw jwtError;
    }
    
  } catch (error) {
    console.error('‚ùå Erro cr√≠tico no middleware de autentica√ß√£o:', error);
    
    return res.status(500).json({
      success: false,
      error: 'Erro interno na autentica√ß√£o',
      details: process.env.NODE_ENV === 'development' ? error.message : undefined
    });
  }
};

module.exports = authMiddleware;
''''''''''''''''''''''''
// ‚úÖ CORRE√á√ÉO: Logger simplificado e funcional
class Logger {
    static info(message, ...args) {
        const timestamp = new Date().toISOString();
        console.log(`‚ÑπÔ∏è ${timestamp} [INFO]: ${message}`, ...args);
    }

    static error(message, ...args) {
        const timestamp = new Date().toISOString();
        console.error(`‚ùå ${timestamp} [ERROR]: ${message}`, ...args);
    }

    static warn(message, ...args) {
        const timestamp = new Date().toISOString();
        console.warn(`‚ö†Ô∏è ${timestamp} [WARN]: ${message}`, ...args);
    }

    static debug(message, ...args) {
        const timestamp = new Date().toISOString();
        console.log(`üêõ ${timestamp} [DEBUG]: ${message}`, ...args);
    }
}

// ‚úÖ CORRE√á√ÉO: Middleware de request logging
const requestLogger = (req, res, next) => {
    const start = Date.now();
    
    res.on('finish', () => {
        const duration = Date.now() - start;
        Logger.info(`${req.method} ${req.originalUrl} - ${res.statusCode} - ${duration}ms`);
    });
    
    next();
};

module.exports = Logger;
module.exports.requestLogger = requestLogger;
''''''''''''''''''''''''''''''''''
const admin = require('firebase-admin');

let firebaseInitialized = false;
let firebaseAdmin = null;

try {
  // Verificar se as vari√°veis de ambiente necess√°rias est√£o dispon√≠veis
  const {
    FIREBASE_PROJECT_ID,
    FIREBASE_CLIENT_EMAIL,
    FIREBASE_PRIVATE_KEY
  } = process.env;

  // Verificar se temos uma chave privada v√°lida (n√£o √© a chave de exemplo)
  const hasValidPrivateKey = FIREBASE_PRIVATE_KEY && 
                            !FIREBASE_PRIVATE_KEY.includes('TEST_KEY_FOR_DEVELOPMENT_ONLY') &&
                            FIREBASE_PRIVATE_KEY.length > 100;

  if (FIREBASE_PROJECT_ID && FIREBASE_CLIENT_EMAIL && hasValidPrivateKey) {
    // Substituir \n por quebras de linha reais na chave privada
    const privateKey = process.env.FIREBASE_PRIVATE_KEY.replace(/\\n/g, '\n');
    
    const serviceAccount = {
      type: "service_account",
      project_id: FIREBASE_PROJECT_ID,
      private_key_id: process.env.FIREBASE_PRIVATE_KEY_ID,
      private_key: privateKey,
      client_email: FIREBASE_CLIENT_EMAIL,
      client_id: process.env.FIREBASE_CLIENT_ID,
      auth_uri: "https://accounts.google.com/o/oauth2/auth",
      token_uri: "https://oauth2.googleapis.com/token",
      auth_provider_x509_cert_url: "https://www.googleapis.com/oauth2/v1/certs",
      client_x509_cert_url: process.env.FIREBASE_CLIENT_X509_CERT_URL,
      universe_domain: "googleapis.com"
    };

    admin.initializeApp({
      credential: admin.credential.cert(serviceAccount),
      databaseURL: `https://${FIREBASE_PROJECT_ID}.firebaseio.com`
    });

    firebaseInitialized = true;
    firebaseAdmin = admin;
    console.log('‚úÖ Firebase Admin inicializado com vari√°veis de ambiente');
    
  } else {
    console.log('üîß Modo desenvolvimento: Firebase n√£o configurado com credenciais v√°lidas');
    console.log('‚ÑπÔ∏è  Usando dados mockados para clientes');
  }
} catch (error) {
  console.log('‚ö†Ô∏è  Firebase n√£o dispon√≠vel. Modo desenvolvimento:', error.message);
  console.log('‚ÑπÔ∏è  O sistema funcionar√° com dados mockados');
}

// Fun√ß√£o para verificar se o Firebase est√° dispon√≠vel
function isFirebaseAvailable() {
  return firebaseInitialized;
}

// Fun√ß√£o para obter a inst√¢ncia do Firebase Admin
function getFirebaseAdmin() {
  return firebaseAdmin;
}

module.exports = {
  isFirebaseAvailable,
  getFirebaseAdmin,
  firebaseAdmin: firebaseInitialized ? admin : null
};
''''''''''''''''''''''''''''
const fs = require('fs');
const path = require('path');
const bcrypt = require('bcryptjs');

const dbPath = path.join(__dirname, '..', 'database', 'data.json');

// Banco de dados em mem√≥ria
let db = {
  users: [],
  categories: [],
  products: [],
  inventory: [],
  sales: [],
  sale_items: [],
  customers: []
};

// Carregar dados do arquivo se existir
if (fs.existsSync(dbPath)) {
  try {
    const data = fs.readFileSync(dbPath, 'utf8');
    db = JSON.parse(data);
    console.log('‚úÖ Dados carregados do arquivo JSON');
  } catch (error) {
    console.log('üÜï Criando novo banco de dados JSON');
  }
}

function saveToFile() {
  try {
    fs.writeFileSync(dbPath, JSON.stringify(db, null, 2));
  } catch (error) {
    console.error('‚ùå Erro ao salvar dados:', error);
  }
}

function initializeDatabase() {
  console.log('üîÑ Inicializando banco de dados JSON...');

  // Inserir usu√°rio admin se n√£o existir
  const adminExists = db.users.find(u => u.username === 'admin');
  if (!adminExists) {
    const defaultPassword = bcrypt.hashSync('admin123', 10);
    db.users.push({
      id: 1,
      username: 'admin',
      email: 'admin@garagem67.com',
      password_hash: defaultPassword,
      role: 'admin',
      full_name: 'Administrador',
      is_active: true,
      created_at: new Date().toISOString()
    });
    console.log('‚úÖ Usu√°rio admin criado: admin / admin123');
  }

  // Inserir categorias padr√£o
  const defaultCategories = [
    { id: 1, name: 'Bebidas Alco√≥licas', description: 'Cervejas, vinhos, destilados' },
    { id: 2, name: 'Bebidas N√£o Alco√≥licas', description: 'Refrigerantes, sucos, √°guas' },
    { id: 3, name: 'Petiscos', description: 'Salgadinhos, por√ß√µes' },
    { id: 4, name: 'Conveni√™ncia', description: 'Produtos de conveni√™ncia' },
    { id: 5, name: 'Outros', description: 'Diversos' }
  ];

  defaultCategories.forEach(category => {
    const exists = db.categories.find(c => c.id === category.id);
    if (!exists) {
      db.categories.push({
        ...category,
        is_active: true,
        created_at: new Date().toISOString()
      });
    }
  });

  console.log('‚úÖ Categorias padr√£o inseridas');
  saveToFile();
  console.log('üéâ Banco de dados JSON inicializado com sucesso!');
}

// Inicializar
initializeDatabase();

// Fun√ß√µes do banco de dados
const database = {
  // Users
  getUsers: () => db.users,
  getUserById: (id) => db.users.find(u => u.id === id),
  getUserByUsername: (username) => db.users.find(u => u.username === username),
  createUser: (userData) => {
    const newUser = {
      id: Math.max(...db.users.map(u => u.id), 0) + 1,
      ...userData,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    db.users.push(newUser);
    saveToFile();
    return newUser;
  },

  // Products
  getProducts: () => db.products,
  getProductById: (id) => db.products.find(p => p.id === id),
  createProduct: (productData) => {
    const newProduct = {
      id: Math.max(...db.products.map(p => p.id), 0) + 1,
      ...productData,
      created_at: new Date().toISOString(),
      updated_at: new Date().toISOString()
    };
    db.products.push(newProduct);
    saveToFile();
    return newProduct;
  },

  // Sales
  getSales: () => db.sales,
  createSale: (saleData) => {
    const newSale = {
      id: Math.max(...db.sales.map(s => s.id), 0) + 1,
      sale_code: `V${Date.now()}${Math.random().toString(36).substr(2, 5)}`.toUpperCase(),
      ...saleData,
      sale_date: new Date().toISOString(),
      sale_status: 'completed'
    };
    db.sales.push(newSale);
    saveToFile();
    return newSale;
  },

  // Customers
  getCustomers: () => db.customers,
  createCustomer: (customerData) => {
    const newCustomer = {
      id: Math.max(...db.customers.map(c => c.id), 0) + 1,
      ...customerData,
      created_at: new Date().toISOString(),
      last_sync: new Date().toISOString()
    };
    db.customers.push(newCustomer);
    saveToFile();
    return newCustomer;
  },

  // Save function
  save: saveToFile
};

module.exports = database;
''''''''''''''''''''''''''''
const Database = require('better-sqlite3');
const path = require('path');
const fs = require('fs');

// ‚úÖ CORRE√á√ÉO: Caminho absoluto para o banco de dados
const dbPath = process.env.NODE_ENV === 'test' 
  ? ':memory:' 
  : path.join(__dirname, '..', 'database.sqlite');

console.log('üóÑÔ∏è Iniciando banco de dados SQLite...');
console.log('üìÅ Caminho do banco:', dbPath);

// Criar diret√≥rio se n√£o existir
if (dbPath !== ':memory:') {
  const dbDir = path.dirname(dbPath);
  if (!fs.existsSync(dbDir)) {
    fs.mkdirSync(dbDir, { recursive: true });
  }
}

const db = new Database(dbPath, {
  verbose: process.env.NODE_ENV === 'development' ? console.log : undefined
});

// ‚úÖ CORRE√á√ÉO: Habilitar chaves estrangeiras
db.pragma('foreign_keys = ON');
db.pragma('journal_mode = WAL');

// ‚úÖ CORRE√á√ÉO: Fun√ß√£o de inicializa√ß√£o do banco
function initializeDatabase() {
  try {
    console.log('üîÑ Inicializando banco de dados...');

    // Criar tabelas
    db.exec(`
      -- Tabela de usu√°rios
      CREATE TABLE IF NOT EXISTS users (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        username TEXT UNIQUE NOT NULL,
        email TEXT UNIQUE,
        password_hash TEXT NOT NULL,
        full_name TEXT,
        role TEXT DEFAULT 'user',
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );

      -- Tabela de categorias
      CREATE TABLE IF NOT EXISTS categories (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        description TEXT,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );

      -- Tabela de produtos
      CREATE TABLE IF NOT EXISTS products (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        description TEXT,
        price DECIMAL(10,2) NOT NULL,
        category_id INTEGER,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (category_id) REFERENCES categories (id)
      );

      -- Tabela de invent√°rio
      CREATE TABLE IF NOT EXISTS inventory (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        product_id INTEGER UNIQUE NOT NULL,
        current_stock INTEGER DEFAULT 0,
        min_stock INTEGER DEFAULT 10,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products (id)
      );

      -- Tabela de movimenta√ß√µes de estoque
      CREATE TABLE IF NOT EXISTS stock_movements (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        product_id INTEGER NOT NULL,
        quantity INTEGER NOT NULL,
        type TEXT NOT NULL,
        reason TEXT,
        user_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (product_id) REFERENCES products (id),
        FOREIGN KEY (user_id) REFERENCES users (id)
      );

      -- Tabela de clientes
      CREATE TABLE IF NOT EXISTS customers (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        name TEXT NOT NULL,
        email TEXT,
        phone TEXT,
        address TEXT,
        is_active INTEGER DEFAULT 1,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        updated_at DATETIME DEFAULT CURRENT_TIMESTAMP
      );

      -- Tabela de vendas
      CREATE TABLE IF NOT EXISTS sales (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        sale_code TEXT UNIQUE NOT NULL,
        customer_id INTEGER,
        total_amount DECIMAL(10,2) NOT NULL,
        payment_method TEXT,
        observations TEXT,
        user_id INTEGER NOT NULL,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (customer_id) REFERENCES customers (id),
        FOREIGN KEY (user_id) REFERENCES users (id)
      );

      -- Tabela de itens de venda
      CREATE TABLE IF NOT EXISTS sale_items (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        sale_id INTEGER NOT NULL,
        product_id INTEGER NOT NULL,
        product_name TEXT NOT NULL,
        quantity INTEGER NOT NULL,
        unit_price DECIMAL(10,2) NOT NULL,
        total_price DECIMAL(10,2) NOT NULL,
        FOREIGN KEY (sale_id) REFERENCES sales (id) ON DELETE CASCADE,
        FOREIGN KEY (product_id) REFERENCES products (id)
      );

      -- Tabela de exporta√ß√µes
      CREATE TABLE IF NOT EXISTS exports (
        id INTEGER PRIMARY KEY AUTOINCREMENT,
        type TEXT NOT NULL,
        filters TEXT,
        file_path TEXT,
        user_id INTEGER,
        created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
        FOREIGN KEY (user_id) REFERENCES users (id)
      );
    `);

    // Inserir categorias padr√£o
    const categoriesStmt = db.prepare(`
      INSERT OR IGNORE INTO categories (name, description) VALUES 
      ('Bebidas', 'Refrigerantes, sucos, √°gua, etc.'),
      ('Snacks', 'Salgadinhos, biscoitos, chocolates'),
      ('Tabacaria', 'Cigarro, fumo, acess√≥rios'),
      ('Conveni√™ncia', 'Produtos de conveni√™ncia em geral'),
      ('Outros', 'Outras categorias de produtos')
    `);
    
    categoriesStmt.run();
    console.log('‚úÖ 5 categorias padr√£o criadas');

    // Inserir usu√°rio admin padr√£o
    const bcrypt = require('bcryptjs');
    const adminPasswordHash = bcrypt.hashSync('admin123', 10);
    
    const userStmt = db.prepare(`
      INSERT OR IGNORE INTO users (username, email, password_hash, full_name, role) 
      VALUES (?, ?, ?, ?, ?)
    `);
    
    userStmt.run('admin', 'admin@garagem67.com', adminPasswordHash, 'Administrador', 'admin');
    console.log('‚úÖ Usu√°rio admin criado');

    console.log('‚úÖ Banco de dados inicializado com sucesso');
    
    // Listar tabelas criadas
    const tablesStmt = db.prepare("SELECT name FROM sqlite_master WHERE type='table'");
    const tables = tablesStmt.all().map(t => t.name);
    console.log('üìä Tabelas criadas:', tables.join(', '));

  } catch (error) {
    console.error('‚ùå Erro na inicializa√ß√£o do banco:', error);
    throw error;
  }
}

// Inicializar o banco
initializeDatabase();

module.exports = db;
''''''''''''''''''''''''''''''''''''
se precisar de algum codigo me avise antes de escrever qualquer codigo, arrume a quest√£o da sincroniza√ß√£o juntamente com o bot√£o ao lado esquerdo do frontend, e me de os codigos editados prontos e completos, pois me perdi nos codigos